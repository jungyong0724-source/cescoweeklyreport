/**
 * ì„¸ìŠ¤ì½” í†µí•© ë§ˆì¼€íŒ… ëŒ€ì‹œë³´ë“œ & AI ë¦¬í¬íŠ¸ (V9.2.1)
 * 2026ë…„ ê¸°ì¤€ | ì „ë…„ ë™ìš”ì¼ ë¹„êµ | ê°œë³„ ë©”ë‰´ ì‹¤í–‰ ì‹œ ë‚ ì§œ ì •ì˜ ì˜¤ë¥˜ í•´ê²°
 */

function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('AI ë³´ê³ ì„œ ê´€ë¦¬')
      .addItem('ì „ì²´ ë°ì´í„° ë™ê¸°í™” ì—…ë°ì´íŠ¸ (ì „ì²´ ë°˜ì˜)', 'updateAllData')
      .addSeparator()
      .addItem('ë°ì´í„° ì—…ë°ì´íŠ¸ (ë‚ ì”¨/ë„¤ì´ë²„/ì´ìŠˆ/ì§€í‘œ)', 'updateExternalData')
      .addItem('ì„œì¹˜ì½˜ì†” ì£¼ê°„ë¹„êµ ì—…ë°ì´íŠ¸ (BQ)', 'updateGSCWeeklyData')
      .addItem('GA4 ë‚´ë¶€ê²€ìƒ‰ì–´ ì£¼ê°„ë¹„êµ ì—…ë°ì´íŠ¸ (BQ)', 'updateGA4WeeklyData')
      .addItem('GA4 í•µì‹¬í˜ì´ì§€ ìœ ì…ë¶„ì„ (BQ)', 'updateGA4InboundWeeklyData')
      .addSeparator()
      .addItem('ì§€ë‚œì£¼ HTML ë³´ê³ ì„œ ìƒˆë¡­ê²Œ ì‘ì„±í•˜ê¸°', 'generateWeeklyReport')
      .addItem('ì‘ì„±ëœ ë³´ê³ ì„œ ë‹¤ì‹œ ë¯¸ë¦¬ë³´ê¸°', 'showSavedReportPreview')
      .addToUi();
}

// [í™˜ê²½ ì„¤ì •ê°’]
const GEMINI_API_KEY = '{APIKEY}';
const NAVER_CLIENT_ID = 'ugxntcbaOqIuh_3y_uLv';
const NAVER_CLIENT_SECRET = 'Hoqaso5G2k';
const WEATHER_SERVICE_KEY = 'BNgXBXi+SL3VYIsQPruhshx9i37x/I/K6S5AFyd+cpu6wzvCjfZTgzu1MYazUfvVcj3wS8O1kZGADjOYUsN++A==';
const BQ_PROJECT_ID = 'cescojungyong';
const GA4_PROJECT_ID = 'cescomall-405900';
const GA4_DATASET_ID = 'analytics_335040662';
const HOLIDAY_CAL_ID = 'ko.south_korea#holiday@group.v.calendar.google.com';

const NAVER_KEYWORD_GROUPS = [
  { groupName: "ì„¸ìŠ¤ì½”", keywords: ["ì„¸ìŠ¤ì½”", "CESCO"] },
  { groupName: "í•´ì¶©", keywords: ["ë°”í€´ë²Œë ˆ", "ê°œë¯¸", "ë¹ˆëŒ€", "ì¥", "ë²¼ë£©"] },
  { groupName: "ë°©ì—­ë¹„ìš©", keywords: ["ì„¸ìŠ¤ì½” ë¹„ìš©", "ì„¸ìŠ¤ì½” ê°€ê²©"] },
  { groupName: "ë¹„ì¦ˆë‹ˆìŠ¤ìœ„ìƒ", keywords: ["ì‹ë‹¹ ë°©ì—­", "HACCP", "í•´ì¹ ì¸ì¦", "ì‹í’ˆìœ„ìƒë²•", "ì˜ì—…ì •ì§€ ìœ„ìƒ"] },
  { groupName: "ì´ì‚¬ë°©ì—­", keywords: ["ì´ì‚¬ ë°©ì—­", "ì…ì£¼ ë°©ì—­", "ìƒˆì§‘ì¦í›„êµ°", "ë¨¼ì§€ë‹¤ë“¬ì´"] },
  { groupName: "ë°©ì—­ë¹„êµ", keywords: ["ë Œí† í‚¬", "í„°ë¯¸ë‹‰ìŠ¤", "ì¼€ì–´ì›", "ë°©ì—­ì—…ì²´ ì¶”ì²œ", "ë™ë„¤ ë°©ì—­","ë°©ì—­ ì—…ì²´ ë¹„ìš©", "ë°”í€´ë²Œë ˆ í‡´ì¹˜ ë¹„ìš©"] }
];

/**
 * [ë‚ ì§œ ì—”ì§„] 2026ë…„ ê¸°ì¤€ ì „ë…„ ë™ìš”ì¼(364ì¼ ì „) ë° MTD ê³„ì‚°
 */
function getReportingPeriods() {
  const today = new Date(); 
  const dayOfWeek = today.getDay();
  const diffToLastMon = (dayOfWeek === 0 ? 6 : dayOfWeek - 1) + 7;
  
  const curStart = new Date(today.getTime() - diffToLastMon * 24 * 60 * 60 * 1000);
  const curEnd = new Date(curStart.getTime() + 6 * 24 * 60 * 60 * 1000);
  
  const prevStart = new Date(curStart.getTime() - 7 * 24 * 60 * 60 * 1000);
  const prevEnd = new Date(curEnd.getTime() - 7 * 24 * 60 * 60 * 1000);
  
  const yearStart = new Date(curStart.getTime() - 364 * 24 * 60 * 60 * 1000);
  const yearEnd = new Date(curEnd.getTime() - 364 * 24 * 60 * 60 * 1000);

  const mtdStart = new Date(curEnd.getFullYear(), curEnd.getMonth(), 1);
  const mtdOldStart = new Date(mtdStart.getTime() - 364 * 24 * 60 * 60 * 1000);

  const f = (d) => Utilities.formatDate(d, "GMT+9", "yyyy-MM-dd");
  const fbq = (d) => Utilities.formatDate(d, "GMT+9", "yyyyMMdd");

  return {
    cur: { start: f(curStart), end: f(curEnd), bq: fbq(curStart), bqEnd: fbq(curEnd) },
    prev: { start: f(prevStart), end: f(prevEnd), bq: fbq(prevStart), bqEnd: fbq(prevEnd) },
    year: { start: f(yearStart), end: f(yearEnd), bq: fbq(yearStart), bqEnd: fbq(yearEnd) },
    mtd: { start: f(mtdStart), end: f(curEnd) },
    mtdYear: { start: f(mtdOldStart), end: f(yearEnd) }
  };
}

/**
 * [ë°ì´í„° ì—”ì§„] ìˆ˜ì¹˜ í•©ì‚° ë¡œì§
 */
function getPeriodStatsExtended(sheet, startStr, endStr) {
  const data = sheet.getDataRange().getValues();
  let res = { 
    total:0, webDbInclKakao:0, emergency:0, webEmSum:0, callIb:0,
    home:0, rest:0, biz:0, etc:0, 
    avgTemp:0, urgencyIndex:0, trendPest:0, issues:[], count:0 
  };

  for (let i = 1; i < data.length; i++) {
    if (!data[i][0]) continue;
    let dStr = (data[i][0] instanceof Date) ? Utilities.formatDate(data[i][0], "GMT+9", "yyyy-MM-dd") : String(data[i][0]);
    if (dStr >= startStr && dStr <= endStr) {
      let dailyWebWithKakao = Number(data[i][5]||0) + Number(data[i][17]||0) + Number(data[i][18]||0);
      let dailyEmergency = Number(data[i][20]||0) + Number(data[i][21]||0);
      
      res.webDbInclKakao += dailyWebWithKakao;
      res.emergency += dailyEmergency;
      res.webEmSum += (dailyWebWithKakao + dailyEmergency);
      res.callIb += Number(data[i][10]||0);
      res.total += Number(data[i][11]||0);

      res.home += (Number(data[i][1]||0) + Number(data[i][6]||0) + Number(data[i][17]||0) + Number(data[i][20]||0));
      res.rest += (Number(data[i][2]||0) + Number(data[i][7]||0) + Number(data[i][18]||0) + Number(data[i][21]||0));
      res.biz  += (Number(data[i][3]||0) + Number(data[i][8]||0));
      res.etc  += (Number(data[i][4]||0) + Number(data[i][9]||0));

      res.avgTemp += Number(data[i][14]||0); 
      res.trendPest += Number(data[i][25]||0);
      res.urgencyIndex += Number(data[i][19]||0);
      if (data[i][31]) res.issues.push(data[i][31]);
      res.count++;
    }
  }
  if(res.count > 0) {
    res.avgTemp = (res.avgTemp / res.count).toFixed(1);
    res.urgencyIndex = (res.urgencyIndex / res.count).toFixed(2);
    res.trendPest = (res.trendPest / res.count).toFixed(1);
  }
  res.issues = [...new Set(res.issues)].join(" / ");
  return res;
}

/**
 * [Main] ë³´ê³ ì„œ ì‘ì„± ë° ì‹œíŠ¸ ì¶œë ¥
 */
function generateWeeklyReport() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dataSheet = ss.getSheetByName('2_ë¡œë°ì´í„°');
  const ga4InboundSheet = ss.getSheetByName('GA4ìœ ì…í‚¤ì›Œë“œ');
  const ga4SearchSheet = ss.getSheetByName('GA4ê²€ìƒ‰ì–´');
  const gscSheet = ss.getSheetByName('êµ¬ê¸€ì„œì¹˜ì½˜ì†”');
  let reportSheet = ss.getSheetByName('ë³´ê³ ì‹œíŠ¸') || ss.insertSheet('ë³´ê³ ì‹œíŠ¸');
  
  const d = getReportingPeriods();
  
  // 1. ë°ì´í„° ì§‘ê³„
  const cur = getDetailedStats(dataSheet, d.cur.start, d.cur.end);
  const pre = getDetailedStats(dataSheet, d.prev.start, d.prev.end);
  const old = getDetailedStats(dataSheet, d.year.start, d.year.end);
  const mtd = getDetailedStats(dataSheet, d.mtd.start, d.mtd.end);
  const mtdOld = getDetailedStats(dataSheet, d.mtdYear.start, d.mtdYear.end);
  
  // 2. í‚¤ì›Œë“œ/ë‰´ìŠ¤ ì¶”ì¶œ
  const topInbound = extractKeywordSummary(ga4InboundSheet, 15, "ìœ ì…");
  const topGSC = extractKeywordSummary(gscSheet, 10, "êµ¬ê¸€ê²€ìƒ‰");
  const newsList = fetchRelatedNews(d.cur.start, d.cur.end);
  const newsContext = newsList.length > 0 ? newsList.map(n => `[${n.date}] ${n.title}`).join(" / ") : "ì—†ìŒ";

  // 4. ì‹œíŠ¸ ë‚´ ìˆ˜ì¹˜ ë°ì´í„° ì‘ì„±
  reportSheet.clear();
  const pctCalc = (c, p) => p > 0 ? ((c-p)/p*100).toFixed(1) + "%" : "0.0%";

  reportSheet.getRange("B2").setValue("1. ì „ë…„ ëŒ€ë¹„ ì›”ê°„ ëˆ„ì  ìˆ˜ì¹˜ ë¹„êµ (MTD)").setFontWeight("bold").setFontSize(12);
  const tableHeader = [["êµ¬ë¶„", "í™ˆí˜ì´ì§€ DB(ì¹´ì¹´ì˜¤ í¬í•¨)", "ê¸´ê¸‰ì§„ë‹¨", "í™ˆí˜ì´ì§€+ê¸´ê¸‰ í•©ê³„", "IB ì½œ", "ì „ì²´ ì‹ ì²­(L)"]];
  const table1Data = [
    ["ë‹¹ì›” ëˆ„ì ", mtd.webDbInclKakao, mtd.emergency, mtd.webEmSum, mtd.callIb, mtd.total],
    ["ì „ë…„ ëˆ„ì ", mtdOld.webDbInclKakao, mtdOld.emergency, mtdOld.webEmSum, mtdOld.callIb, mtdOld.total],
    ["ì¦ê°(%)", pctCalc(mtd.webDbInclKakao, mtdOld.webDbInclKakao), pctCalc(mtd.emergency, mtdOld.emergency), pctCalc(mtd.webEmSum, mtdOld.webEmSum), pctCalc(mtd.callIb, mtdOld.callIb), pctCalc(mtd.total, mtdOld.total)]
  ];
  reportSheet.getRange("B3:G3").setValues(tableHeader).setBackground("#0b5394").setFontColor("white").setHorizontalAlignment("center");
  reportSheet.getRange("B4:G6").setValues(table1Data).setHorizontalAlignment("center").setBorder(true, true, true, true, true, true);
  reportSheet.getRange("B6:G6").setFontWeight("bold").setFontColor("red");

  reportSheet.getRange("B8").setValue("2. ì „ë…„/ì „ì£¼ ëŒ€ë¹„ ì£¼ê°„ ìˆ˜ì¹˜ ë¹„êµ").setFontWeight("bold").setFontSize(12);
  const table2Data = [
    [`ê¸ˆì£¼ (${d.cur.start})`, cur.webDbInclKakao, cur.emergency, cur.webEmSum, cur.callIb, cur.total],
    [`ì „ë…„ ë™ìš”ì¼ (${d.year.start})`, old.webDbInclKakao, old.emergency, old.webEmSum, old.callIb, old.total],
    ["ì „ë…„ ëŒ€ë¹„ (%)", pctCalc(cur.webDbInclKakao, old.webDbInclKakao), pctCalc(cur.emergency, old.emergency), pctCalc(cur.webEmSum, old.webEmSum), pctCalc(cur.callIb, old.callIb), pctCalc(cur.total, old.total)],
    [`ì „ì£¼ (${d.prev.start})`, pre.webDbInclKakao, pre.emergency, pre.webEmSum, pre.callIb, pre.total],
    ["ì „ì£¼ ëŒ€ë¹„ (%)", pctCalc(cur.webDbInclKakao, pre.webDbInclKakao), pctCalc(cur.emergency, pre.emergency), pctCalc(cur.webEmSum, pre.webEmSum), pctCalc(cur.callIb, pre.callIb), pctCalc(cur.total, pre.total)]
  ];
  reportSheet.getRange("B9:G9").setValues(tableHeader).setBackground("#0b5394").setFontColor("white").setHorizontalAlignment("center");
  reportSheet.getRange("B10:G14").setValues(table2Data).setHorizontalAlignment("center").setBorder(true, true, true, true, true, true);

  // 5. AI ë¶„ì„ ë¦¬í¬íŠ¸ ìƒì„±
  const prompt = `ë‹¹ì‹ ì€ ì„¸ìŠ¤ì½” ì‹œë‹ˆì–´ ì „ëµ ë§ˆì¼€í„°ì…ë‹ˆë‹¤. ì•„ë˜ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ [ì „ì£¼ ëŒ€ë¹„(WoW)]ì™€ [ì „ë…„ ë™ìš”ì¼ ëŒ€ë¹„(YoY)] ì„±ê³¼ ì¸ê³¼ê´€ê³„ë¥¼ í•­ëª©ë³„(ê°€~ë¼)ë¡œ ìƒì„¸íˆ ë¶„ì„í•˜ì„¸ìš”.

    [ì‘ì„± ê·œì¹™] 
    1. HTML ì „ìš©: ë§ˆí¬ë‹¤ìš´(**) ê¸ˆì§€. <b>, <br>, <p> íƒœê·¸ë§Œ ì‚¬ìš©.
    2. ì „ì£¼ ë° ì „ë…„ ë¶„ì„ ë¹„ì¤‘ì„ 1:1ë¡œ í•˜ì—¬ ë§¤ìš° ìƒì„¸íˆ ì‘ì„±í•  ê²ƒ.
    3. ë°ì´í„°ì— ê¸°ë°˜í•˜ì—¬ ë‹¨ì •ì ì¸ ì–´ì¡°(~ì…ë‹ˆë‹¤)ë¡œ ì‘ì„±í•  ê²ƒ.
    - ë¸Œëœë“œ(ì„¸ìŠ¤ì½”) í‚¤ì›Œë“œë¿ë§Œ ì•„ë‹ˆë¼ í•´ì¶©, ë¹„ìš©, ë¹„ì¦ˆë‹ˆìŠ¤ìœ„ìƒ, ì´ì‚¬, ë¹„êµ ê²€ìƒ‰ ìˆ˜ìš”ì˜ ë³€í™”ë¥¼ ì„±ê³¼ì™€ ì—°ê²°í•˜ì„¸ìš”.
    - ì˜ˆ: "ì´ì‚¬ë°©ì—­ íŠ¸ë Œë“œê°€ ê¸‰ì¦í•œ ê²ƒì´ GA4 ìœ ì…ìƒì„¸ì˜ íŠ¹ì • ê²½ë¡œ ì„±ê³¼ì™€ ì¸ê³¼ê´€ê³„ê°€ ìˆëŠ”ì§€" ë“±ì„ ë¶„ì„.
    
    [í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§: ì¤‘ìš”]
    - ì„¸ìŠ¤ì½” ê³ ê°ì„¼í„°ëŠ” ê³µíœ´ì¼ì— íœ´ë¬´ì…ë‹ˆë‹¤. 
    - ê³µíœ´ì¼ ë³€ìˆ˜: ì„¸ìŠ¤ì½” ê³ ê°ì„¼í„°ëŠ” ê³µíœ´ì¼ì— íœ´ë¬´ì…ë‹ˆë‹¤. 
    - ë§Œì•½ ë¹„êµ ê¸°ê°„ ì¤‘ "ê³µíœ´ì¼"ì´ í¬í•¨ë˜ì–´ ìœ ì…ì½œ(IB)ì´ ì „ì£¼ë‚˜ ì „ë…„ ëŒ€ë¹„ í•˜ë½í–ˆë‹¤ë©´, ì´ë¥¼ ê°€ì¥ ë¨¼ì € ì–¸ê¸‰í•˜ì—¬ ì‹¤ì  ì™œê³¡ì„ ë°”ë¡œì¡ìœ¼ì„¸ìš”.
    - ì˜ˆ: "ê¸ˆì£¼ëŠ” ì „ë…„ ë™ìš”ì¼ ëŒ€ë¹„ ê³µíœ´ì¼(${cur.holidayCount}ì¼ vs ${old.holidayCount}ì¼) ì˜í–¥ìœ¼ë¡œ ìœ ì…ì½œì´ ë¬¼ë¦¬ì ìœ¼ë¡œ ê°ì†Œí–ˆìœ¼ë‚˜, í™ˆí˜ì´ì§€ ì‹ ì²­ì€ ê²¬ì¡°í•©ë‹ˆë‹¤."

    [í•µì‹¬ ë¶„ì„ ë°ì´í„°]
    - ê¸°ê°„: ê¸ˆì£¼(${d.cur.start} ~ ${d.cur.end}), ì „ì£¼(${d.prev.start}), ì „ë…„(${d.year.start})
    - ì „ì²´ ì‹¤ì : ê¸ˆì£¼(${cur.total}ê±´) / ì „ì£¼(${pre.total}ê±´) / ì „ë…„(${old.total}ê±´)
    - í†µí•© ì—…ì¢…(ê°€ì •/ìš”ì‹/ì‚¬ì—…ì²´): 
        * ê¸ˆì£¼: ${cur.home} / ${cur.rest} / ${cur.biz}
        * ì „ì£¼: ${pre.home} / ${pre.rest} / ${pre.biz}
        * ì „ë…„: ${old.home} / ${old.rest} / ${old.biz}
    - ê¸´ê¸‰ë„(T): ê¸ˆì£¼(${cur.urgencyIndex}) / ì „ì£¼(${pre.urgencyIndex}) / ì „ë…„(${old.urgencyIndex})
    - í™˜ê²½ ì§€í‘œ: 
        * í‰ê·  ê¸°ì˜¨: ê¸ˆì£¼ ${cur.avgTemp}ë„ (ì „ì£¼: ${pre.avgTemp}ë„, ì „ë…„: ${old.avgTemp}ë„)
        * ë„¤ì´ë²„ í‚¤ì›Œë“œ ì§€ìˆ˜ (ê¸ˆì£¼ | ì „ì£¼ì°¨ | ì „ë…„ì°¨):
      - ë„¤ì´ë²„ í‚¤ì›Œë“œ íŠ¸ë Œë“œ ì§€ìˆ˜:
        - ë¸Œëœë“œ(ì„¸ìŠ¤ì½”): ê¸ˆì£¼(${cur.trendCesco}) / ì „ì£¼(${pre.trendCesco}) / ì „ë…„(${old.trendCesco})
        - ì¼ë°˜í•´ì¶©: ê¸ˆì£¼(${cur.trendPest}) / ì „ì£¼(${pre.trendPest}) / ì „ë…„(${old.trendPest})
        - ë°©ì—­ë¹„ìš©: ê¸ˆì£¼(${cur.trendCost}) / ì „ì£¼(${pre.trendCost}) / ì „ë…„(${old.trendCost})
        - ë¹„ì¦ˆë‹ˆìŠ¤ìœ„ìƒ: ê¸ˆì£¼(${cur.trendBiz}) / ì „ì£¼(${pre.trendBiz}) / ì „ë…„(${old.trendBiz})
        - ì´ì‚¬ë°©ì—­: ê¸ˆì£¼(${cur.trendMoving}) / ì „ì£¼(${pre.trendMoving}) / ì „ë…„(${old.trendMoving})
        - ë°©ì—­ê²½ìŸì‚¬: ê¸ˆì£¼(${cur.trendComp}) / ì „ì£¼(${pre.trendComp}) / ì „ë…„(${old.trendComp})
    - ì™¸ë¶€ ì´ìŠˆ ë‰´ìŠ¤: ${newsContext}
    - GA4 ìœ ì…ìƒì„¸(ìœ ì…ë³€ë™ëŸ‰): ${topInbound}
    - GSC ê²€ìƒ‰í´ë¦­: ${topGSC}
    - ë‚´ë¶€ì´ìŠˆ/ê³µíœ´ì¼: ${cur.issues} / ${cur.holidays || "ì—†ìŒ"}

    [ëª©ì°¨]
    1. ì „ì£¼ ëŒ€ë¹„(WoW) ì„±ê³¼ ì¸ê³¼ê´€ê³„ ìƒì„¸ ë¶„ì„ (ê°€.ì™¸ë¶€í˜„í™© ë‚˜.ìœ ì…ì±„ë„ ë‹¤.ë„¤ì´ë²„íŠ¸ë Œë“œ ë¼.ê¸°íƒ€)
    2. ì „ë…„ ëŒ€ë¹„(YoY) ì„±ê³¼ ì¸ê³¼ê´€ê³„ ìƒì„¸ ë¶„ì„ (ê°€.ì™¸ë¶€í˜„í™© ë‚˜.ìœ ì…ì±„ë„ ë‹¤.ë„¤ì´ë²„íŠ¸ë Œë“œ ë¼.ê¸°íƒ€)
    3. ê¸´ê¸‰ë„ ì§€í‘œ(T) ì§„ë‹¨ ë° ì „ëµ ì œì–¸
  `;

  const aiContent = callGemini(prompt).replace(/\*\*/g, ""); 
  const finalHtml = getEmailTemplate(d, cur, pre, old, mtd, mtdOld, aiContent, newsList);

  reportSheet.getRange("B29").setValue("â–¼ ì•„ë˜ HTML ì†ŒìŠ¤ë¥¼ ë³µì‚¬í•˜ì—¬ ë©”ì¼ì— ì‚¬ìš©í•˜ì„¸ìš”").setFontWeight("bold");
  reportSheet.getRange("B30").setValue(finalHtml);

  showSavedReportPreview();
}


/**
 * [BigQuery] GA4 í•µì‹¬í˜ì´ì§€ ìœ ì…ë¶„ì„ (8ê°œ ì»¬ëŸ¼ ë³µêµ¬ ë° ì—ëŸ¬ í•´ê²°)
 */
function updateGA4InboundWeeklyData(dates) {
  // [ì¶”ê°€] ë©”ë‰´ì—ì„œ ì§ì ‘ í´ë¦­í–ˆì„ ë•Œ ë‚ ì§œë¥¼ ëª» ì°¾ëŠ” ì—ëŸ¬ ë°©ì§€
  if (!dates) dates = getReportingPeriods();

  const sql = `
    WITH session_raw AS (
      SELECT 
        user_pseudo_id,
        (SELECT value.int_value FROM UNNEST(event_params) WHERE key = 'ga_session_id') as session_id,
        traffic_source.source, 
        traffic_source.medium, 
        -- í‚¤ì›Œë“œê°€ ì—†ìœ¼ë©´ ë§¤ì²´ëª…ì„ ê´„í˜¸ë¡œ í‘œì‹œ
        COALESCE((SELECT value.string_value FROM UNNEST(event_params) WHERE key = 'term'), CONCAT('(', traffic_source.medium, ')')) as keyword,
        CASE 
          WHEN _TABLE_SUFFIX BETWEEN '${dates.cur.bq}' AND '${dates.cur.bqEnd}' THEN 'cur'
          WHEN _TABLE_SUFFIX BETWEEN '${dates.prev.bq}' AND '${dates.prev.bqEnd}' THEN 'prev'
          WHEN _TABLE_SUFFIX BETWEEN '${dates.year.bq}' AND '${dates.year.bqEnd}' THEN 'year'
        END as period,
        -- íŠ¹ì • í˜ì´ì§€(ì‹ ì²­ì„œ ë“±) ë°©ë¬¸ ì—¬ë¶€ ì²´í¬
        MAX(CASE WHEN EXISTS (SELECT 1 FROM UNNEST(event_params) WHERE key = 'page_location' AND (value.string_value LIKE '%estimate%' OR value.string_value LIKE '%G2000001274%')) THEN 1 ELSE 0 END) as is_target
      FROM \`${GA4_PROJECT_ID}.${GA4_DATASET_ID}.events_*\`
      WHERE _TABLE_SUFFIX BETWEEN '${dates.year.bq}' AND '${dates.cur.bqEnd}'
      GROUP BY 1, 2, 3, 4, 5, 6
    )
    SELECT 
      source, 
      medium, 
      keyword,
      -- 0, 1ì´ ì•„ë‹Œ ì‹¤ì œ 'ìœ ë‹ˆí¬ ì„¸ì…˜ ìˆ˜'ë¥¼ ì¹´ìš´íŠ¸í•©ë‹ˆë‹¤.
      COUNT(DISTINCT IF(period = 'cur' AND is_target = 1, CONCAT(user_pseudo_id, CAST(session_id AS STRING)), NULL)) as cur_vol,
      COUNT(DISTINCT IF(period = 'prev' AND is_target = 1, CONCAT(user_pseudo_id, CAST(session_id AS STRING)), NULL)) as prev_vol,
      COUNT(DISTINCT IF(period = 'year' AND is_target = 1, CONCAT(user_pseudo_id, CAST(session_id AS STRING)), NULL)) as year_vol
    FROM session_raw
    WHERE period IS NOT NULL
    GROUP BY 1, 2, 3
    HAVING cur_vol > 0 OR prev_vol > 0
    ORDER BY cur_vol DESC
    LIMIT 500
  `;

  const results = runBQQuery(sql, GA4_PROJECT_ID);
  let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('GA4ìœ ì…í‚¤ì›Œë“œ') || SpreadsheetApp.getActiveSpreadsheet().insertSheet('GA4ìœ ì…í‚¤ì›Œë“œ');
  
  sheet.clear(); 
  // ê¸°ì¡´ 8ê°œ í—¤ë” ìœ ì§€
  sheet.getRange(1,1,1,8).setValues([["ì†ŒìŠ¤","ë§¤ì²´","í•µì‹¬ìœ ì…ê²½ë¡œ","ë³´ê³ ì£¼","ì „ì£¼","ì „ë…„ë™ê¸°","WoWì¦ê°","YoYì¦ê°"]]);
  sheet.getRange(1,1,1,8).setBackground("#0b5394").setFontColor("white").setFontWeight("bold");

  if (results.length > 0) {
    // 8ê°œ ì»¬ëŸ¼ì— ë§ì¶° ë°ì´í„° ë§µí•‘ (ì¦ê°ë¶„ ê³„ì‚° í¬í•¨)
    const finalResults = results.map(r => {
      const c = Number(r[3] || 0);
      const p = Number(r[4] || 0);
      const y = Number(r[5] || 0);
      return [
        r[0], r[1], r[2], // ì†ŒìŠ¤, ë§¤ì²´, ê²½ë¡œ
        c, p, y,          // í˜„ì¬, ì „ì£¼, ì „ë…„ ìˆ˜ì¹˜
        (c - p),          // WoWì¦ê°
        (c - y)           // YoYì¦ê°
      ];
    });
    sheet.getRange(2, 1, finalResults.length, 8).setValues(finalResults);
  }
  SpreadsheetApp.getUi().alert("GA4 ìœ ì… ì„¸ì…˜ëŸ‰ ì§‘ê³„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
}

/**
 * [V15.7] ìƒì„¸ ë°ì´í„° ì§‘ê³„ ì—”ì§„ - ë‚ ì§œ ì¸ì‹ ë° ê¸°ì˜¨ ê³„ì‚° ì •í™•ë„ ê°•í™”
 */
function getDetailedStats(sheet, startStr, endStr) {
  const data = sheet.getDataRange().getValues();
  let res = { 
    total:0, webDbInclKakao:0, emergency:0, webEmSum:0, callIb:0, home:0, rest:0, biz:0,
    avgTemp:0, urgencyIndex:0, 
    trendCesco:0, trendPest:0, trendCost:0, trendBiz:0, trendMoving:0, trendComp:0,
    issues:[], holidays:[], holidayCount:0, count:0, tempCount:0 
  };

  for (let i = 1; i < data.length; i++) {
    let rawDate = data[i][0];
    if (!rawDate) continue;

    // [í•µì‹¬ ìˆ˜ì •] ì‹œíŠ¸ì˜ ë‚ ì§œ í˜•ì‹ì„ yyyy-MM-dd ë¬¸ìì—´ë¡œ ê°•ì œ ë³€í™˜ (ì •ê·œí™”)
    let dStr = "";
    try {
      if (rawDate instanceof Date) {
        dStr = Utilities.formatDate(rawDate, "GMT+9", "yyyy-MM-dd");
      } else {
        // ìˆ«ìë§Œ ì¶”ì¶œí•´ì„œ yyyy-MM-ddë¡œ ì¬êµ¬ì„± (2025.01.27 ë“± í…ìŠ¤íŠ¸ ëŒ€ì‘)
        let clean = String(rawDate).replace(/[^0-9]/g, ""); 
        if (clean.length >= 8) {
          dStr = clean.substring(0,4) + "-" + clean.substring(4,6) + "-" + clean.substring(6,8);
        }
      }
    } catch(e) { continue; }

    // ì •ê·œí™”ëœ ë‚ ì§œë¡œ ê¸°ê°„ ë¹„êµ
    if (dStr >= startStr && dStr <= endStr) {
      res.callIb += Number(data[i][10]||0); 
      res.total += Number(data[i][11]||0);
      res.webDbInclKakao += (Number(data[i][5]||0) + Number(data[i][17]||0) + Number(data[i][18]||0));
      res.emergency += (Number(data[i][20]||0) + Number(data[i][21]||0));
      res.webEmSum += (Number(data[i][5]||0) + Number(data[i][17]||0) + Number(data[i][18]||0) + Number(data[i][20]||0) + Number(data[i][21]||0));
      
      res.home += (Number(data[i][1]||0) + Number(data[i][6]||0) + Number(data[i][17]||0) + Number(data[i][20]||0));
      res.rest += (Number(data[i][2]||0) + Number(data[i][7]||0) + Number(data[i][18]||0) + Number(data[i][21]||0));
      res.biz  += (Number(data[i][3]||0) + Number(data[i][8]||0));

      // ê¸°ì˜¨ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ë§Œ í•©ì‚° (ë¹ˆ ì…€ 0ë„ ì²˜ë¦¬ ë°©ì§€)
      if (data[i][14] !== "" && !isNaN(data[i][14])) {
        res.avgTemp += Number(data[i][14]);
        res.tempCount++;
      }
      
      res.urgencyIndex += Number(data[i][19]||0);
      res.trendCesco += Number(data[i][24]||0);
      res.trendPest  += Number(data[i][25]||0);
      res.trendCost  += Number(data[i][26]||0);
      res.trendBiz   += Number(data[i][27]||0);
      res.trendMoving += Number(data[i][28]||0);
      res.trendComp   += Number(data[i][29]||0);
      
      if (data[i][30] && String(data[i][30]).trim() !== "") {
        res.holidays.push(data[i][30]);
        res.holidayCount++;
      }
      if (data[i][31]) res.issues.push(data[i][31]);
      res.count++;
    }
  }
  
  if(res.count > 0) {
    // ê¸°ì˜¨ì€ ì‹¤ì œ ë°ì´í„°ê°€ ê¸°ë¡ëœ ë‚ ì§œ ìˆ˜ë¡œ ë‚˜ëˆ”
    res.avgTemp = res.tempCount > 0 ? (res.avgTemp / res.tempCount).toFixed(1) : "0.0";
    res.urgencyIndex = (res.urgencyIndex / res.count).toFixed(2);
    ["trendCesco", "trendPest", "trendCost", "trendBiz", "trendMoving", "trendComp"].forEach(k => {
      res[k] = (res[k] / res.count).toFixed(1);
    });
  }
  res.holidays = [...new Set(res.holidays)].join(", ");
  res.issues = [...new Set(res.issues)].join(" / ");
  return res;
}





/**
 * [í‚¤ì›Œë“œ ì—”ì§„] ê° ì‹œíŠ¸ë³„ ìš”ì•½ ì •ë³´ ìƒì„±
 */
function extractKeywordSummary(sheet, limit, type) {
  if (!sheet || sheet.getLastRow() < 2) return "ë°ì´í„° ì—†ìŒ";
  // 5ë¥¼ 8ë¡œ ìˆ˜ì •í•˜ì—¬ Hì—´ê¹Œì§€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
  const data = sheet.getRange(2, 1, Math.min(sheet.getLastRow()-1, limit), 8).getValues(); 
  return data.map(r => {
    if (type === "ìœ ì…") {
      // r[6]ì€ WoWì¦ê°(Gì—´), r[7]ì€ YoYì¦ê°(Hì—´)ì…ë‹ˆë‹¤.
      return `${r[2]}(í´ë¦­:${r[3]}, WoW:${r[6]||0}, YoY:${r[7]||0})`; 
    }
    return `${r[0]}(ìˆ˜ì¹˜:${r[1]})`;
  }).join(", ");
}


/**
 * [BigQuery] GSC ì£¼ê°„ë¹„êµ
 */
/**
 * [ë³µêµ¬/ê°•í™”] êµ¬ê¸€ ì„œì¹˜ì½˜ì†” ì£¼ê°„ ë¹„êµ ì—…ë°ì´íŠ¸ (5ê°œ ì§€í‘œ ì‹œìŠ¤í…œ)
 */
function updateGSCWeeklyData(dates) {
  if (!dates) dates = getReportingPeriods();

  const sql = `
    WITH base AS (
      SELECT 
        query, 
        clicks,
        CASE 
          WHEN data_date BETWEEN '${dates.cur.start}' AND '${dates.cur.end}' THEN 'cur'
          WHEN data_date BETWEEN '${dates.prev.start}' AND '${dates.prev.end}' THEN 'prev'
          WHEN data_date BETWEEN '${dates.year.start}' AND '${dates.year.end}' THEN 'year'
        END as period
      FROM \`${BQ_PROJECT_ID}.searchconsole_cesco.searchdata_site_impression\`
      WHERE data_date BETWEEN '${dates.year.start}' AND '${dates.cur.end}'
    )
    SELECT 
      query,
      CAST(SUM(IF(period = 'cur', clicks, 0)) AS INT64) as cur_clicks,
      CAST(SUM(IF(period = 'prev', clicks, 0)) AS INT64) as prev_clicks,
      CAST(SUM(IF(period = 'year', clicks, 0)) AS INT64) as year_clicks,
      CAST(SUM(IF(period = 'cur', clicks, 0)) - SUM(IF(period = 'prev', clicks, 0)) AS INT64) as wow_diff,
      CAST(SUM(IF(period = 'cur', clicks, 0)) - SUM(IF(period = 'year', clicks, 0)) AS INT64) as yoy_diff
    FROM base
    WHERE period IS NOT NULL
    GROUP BY 1
    HAVING cur_clicks > 0 OR prev_clicks > 0
    ORDER BY cur_clicks DESC
    LIMIT 100
  `;

  const results = runBQQuery(sql, BQ_PROJECT_ID);
  let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('êµ¬ê¸€ì„œì¹˜ì½˜ì†”') || SpreadsheetApp.getActiveSpreadsheet().insertSheet('êµ¬ê¸€ì„œì¹˜ì½˜ì†”');
  
  sheet.clear();
  const header = [["í‚¤ì›Œë“œ", "ë³´ê³ ì£¼", "ì „ì£¼", "ì „ë…„ ë™ê¸°", "WoW(ì¦ê°)", "YoY(ì¦ê°)"]];
  sheet.getRange(1, 1, 1, 6).setValues(header).setBackground("#45818e").setFontColor("white").setFontWeight("bold");

  if (results.length > 0) {
    sheet.getRange(2, 1, results.length, 6).setValues(results);
  }
  SpreadsheetApp.getUi().alert("êµ¬ê¸€ ì„œì¹˜ì½˜ì†” 5ëŒ€ ì§€í‘œ ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
}

/**
 * [BigQuery] GA4 ë‚´ë¶€ ê²€ìƒ‰ì–´
 */
function updateGA4WeeklyData(dates) {
  // [í•µì‹¬ ì¶”ê°€] ë©”ë‰´ì—ì„œ ì§ì ‘ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ë‚ ì§œ ë³´ë”°ë¦¬ë¥¼ ìë™ìœ¼ë¡œ ì±„ì›Œì£¼ëŠ” ì•ˆì „ì¥ì¹˜
  if (!dates) dates = getReportingPeriods();

  const sql = `
    WITH base AS (
      SELECT 
        COALESCE((SELECT value.string_value FROM UNNEST(event_params) WHERE key = 'search_term'), 'N/A') as keyword, 
        CASE 
          WHEN _TABLE_SUFFIX BETWEEN '${dates.cur.bq}' AND '${dates.cur.bqEnd}' THEN 'cur' 
          WHEN _TABLE_SUFFIX BETWEEN '${dates.prev.bq}' AND '${dates.prev.bqEnd}' THEN 'prev' 
          WHEN _TABLE_SUFFIX BETWEEN '${dates.year.bq}' AND '${dates.year.bqEnd}' THEN 'year' 
        END as period 
      FROM \`${GA4_PROJECT_ID}.${GA4_DATASET_ID}.events_*\` 
      WHERE _TABLE_SUFFIX BETWEEN '${dates.year.bq}' AND '${dates.cur.bqEnd}' 
        AND event_name = 'view_search_results'
    ) 
    SELECT 
      keyword, 
      COUNTIF(period = 'cur') as cur, 
      COUNTIF(period = 'prev') as prev, 
      COUNTIF(period = 'year') as year, 
      (COUNTIF(period = 'cur') - COUNTIF(period = 'prev')) as wow, 
      (COUNTIF(period = 'cur') - COUNTIF(period = 'year')) as yoy 
    FROM base 
    WHERE keyword != 'N/A' 
    GROUP BY 1 
    HAVING cur > 0 OR prev > 0 
    ORDER BY cur DESC 
    LIMIT 300
  `;

  const results = runBQQuery(sql, GA4_PROJECT_ID);
  let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('GA4ê²€ìƒ‰ì–´') || SpreadsheetApp.getActiveSpreadsheet().insertSheet('GA4ê²€ìƒ‰ì–´');
  
  sheet.clear(); 
  // ê¸°ì¡´ 6ê°œ í—¤ë” ê·¸ëŒ€ë¡œ ìœ ì§€
  sheet.getRange(1,1,1,6).setValues([["ë‚´ë¶€ê²€ìƒ‰ì–´(GA4)","ë³´ê³ ì£¼","ì „ì£¼","ì „ë…„ë™ê¸°","WoW","YoY"]]);
  sheet.getRange(1,1,1,6).setBackground("#0b5394").setFontColor("white").setFontWeight("bold");

  if (results.length > 0) {
    sheet.getRange(2,1,results.length,6).setValues(results);
  }
  
  SpreadsheetApp.getUi().alert("GA4 ë‚´ë¶€ê²€ìƒ‰ì–´ ì£¼ê°„ë¹„êµ(6ê°œ í•­ëª©) ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
}

// ê³µí†µ í•¨ìˆ˜êµ°
function updateAllData() { const d = getReportingPeriods(); updateExternalData(); updateGSCWeeklyData(d); updateGA4WeeklyData(d); updateGA4InboundWeeklyData(d); }
function runBQQuery(sql, pId) { try { return BigQuery.Jobs.query({ query: sql, useLegacySql: false }, pId).rows?.map(row => row.f.map(col => col.v)) || []; } catch(e) { return []; } }
/**
 * [ì˜¤ë¥˜ ìˆ˜ì •ë³¸] Gemini API í˜¸ì¶œ ì—”ì§„ (ì•ˆì „ì„± ë° ì˜ˆì™¸ì²˜ë¦¬ ê°•í™”)
 * TypeError: Cannot read properties of undefined (reading '0') ë¬¸ì œë¥¼ ì›ì²œ ì°¨ë‹¨í•©ë‹ˆë‹¤.
 */
/**
 * [V14.1] Gemini 2.0 Flash ëª¨ë¸ ì „ìš© í˜¸ì¶œ ì—”ì§„
 * TypeError: Cannot read properties of undefined (reading '0') ì™„ë²½ ë°©ì–´
 */
function callGemini(prompt) {
  // ë§ˆì¼€í„°ë‹˜ì´ ì§€ì •í•˜ì‹  2.0 Flash ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
  
  const payload = {
    "contents": [{
      "parts": [{
        "text": prompt
      }]
    }],
    // ì„¸ìŠ¤ì½” ë°©ì—­ ê´€ë ¨ ë‹¨ì–´(ë°•ë©¸, ë²Œë ˆ ë“±)ê°€ ê²€ì—´ë˜ì§€ ì•Šë„ë¡ ëª¨ë“  í•„í„° í•´ì œ
    "safetySettings": [
      { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
    ],
    "generationConfig": {
      "temperature": 0.7,
      "maxOutputTokens": 2048
    }
  };

  const options = {
    "method": "post",
    "contentType": "application/json",
    "payload": JSON.stringify(payload),
    "muteHttpExceptions": true // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ ì„¤ì •
  };

  try {
    const response = UrlFetchApp.fetch(url, options);
    const resText = response.getContentText();
    const json = JSON.parse(resText);

    // ë¡œê·¸ í™•ì¸ìš© (ì—ëŸ¬ ë°œìƒ ì‹œ ì‹¤í–‰ ê¸°ë¡ì—ì„œ í™•ì¸ ê°€ëŠ¥)
    if (response.getResponseCode() !== 200) {
      console.error("Gemini API Error Response: " + resText);
      return "ë¶„ì„ ì‹¤íŒ¨: API ì„œë²„ì—ì„œ ì—ëŸ¬ë¥¼ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. (í‚¤ ê¶Œí•œ ë˜ëŠ” í• ë‹¹ëŸ‰ í™•ì¸ í•„ìš”)";
    }

    // [í•µì‹¬ ë°©ì–´] candidates ë°°ì—´ì´ ìˆê³ , ê·¸ ì•ˆì— ë‚´ìš©ì´ ìˆëŠ”ì§€ ë‹¨ê³„ë³„ë¡œ í™•ì¸
    if (json.candidates && json.candidates.length > 0 && 
        json.candidates[0].content && 
        json.candidates[0].content.parts && 
        json.candidates[0].content.parts.length > 0) {
      
      return json.candidates[0].content.parts[0].text;
    
    } else {
      // ë‹µë³€ì´ ìƒì„±ë˜ì§€ ì•Šì€ ê²½ìš° (ì£¼ë¡œ ì„¸ì´í”„í‹° í•„í„° ì‘ë™ ì‹œ)
      console.warn("No Candidates Found. Full JSON: " + resText);
      return "ë°ì´í„° ë¶„ì„ ì‹¤íŒ¨: AIê°€ ë‹µë³€ ìƒì„±ì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤. (ì…ë ¥ ë°ì´í„° í™•ì¸ í•„ìš”)";
    }

  } catch (e) {
    console.error("Critical Connection Error: " + e.toString());
    return "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: AI ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
  }
}
function showSavedReportPreview() { const h = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ë³´ê³ ì‹œíŠ¸')?.getRange("B30").getValue(); if (h) SpreadsheetApp.getUi().showModalDialog(HtmlService.createHtmlOutput(h).setWidth(950).setHeight(850), 'ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸°'); }


/**
 * [V15.1] ì™¸ë¶€ ë°ì´í„°(ë‚ ì”¨, ë„¤ì´ë²„ íŠ¸ë Œë“œ, ì§€í‘œ) ë™ê¸°í™” ì—”ì§„
 * ReferenceError ë° SyntaxError ì™„ë²½ í•´ê²° ë²„ì „
 */
/**
 * [V15.3] ì™¸ë¶€ ë°ì´í„°(ë‚ ì”¨, íŠ¸ë Œë“œ, ì§€í‘œ) ë™ê¸°í™” ì—”ì§„ - ë‚ ì§œ ë§¤ì¹­ ë²„ê·¸ ì™„ë²½ ìˆ˜ì •
 */
function updateExternalData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('2_ë¡œë°ì´í„°');
  if (!sheet) { SpreadsheetApp.getUi().alert("2_ë¡œë°ì´í„° ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

  const today = new Date();
  // ë‚ ì”¨ìš©: ìµœê·¼ 45ì¼ (ì¶©ë¶„í•œ ë²„í¼)
  const last45Days = Utilities.formatDate(new Date(today.getTime() - 45 * 24 * 60 * 60 * 1000), "GMT+9", "yyyyMMdd");
  const yesterdayStr = Utilities.formatDate(new Date(today.getTime() - 24 * 60 * 60 * 1000), "GMT+9", "yyyyMMdd");
  
  // ë„¤ì´ë²„ìš©: 1ë…„ ì „ë¶€í„° ì–´ì œê¹Œì§€ (ì „ë…„ ë™ìš”ì¼ ë¹„êµë¥¼ ìœ„í•´)
  const oneYearAgo = Utilities.formatDate(new Date(today.getFullYear()-1, today.getMonth(), today.getDate()-7), "GMT+9", "yyyy-MM-dd");
  const yesterdayFmt = Utilities.formatDate(new Date(today.getTime() - 24 * 60 * 60 * 1000), "GMT+9", "yyyy-MM-dd");
  
  // 1. ì™¸ë¶€ ë°ì´í„° API í˜¸ì¶œ
  const weatherData = fetchWeatherDataRange(last45Days, yesterdayStr);
  const naverData = fetchNaverTrendRange(oneYearAgo, yesterdayFmt);
  const holidayCal = CalendarApp.getCalendarById(HOLIDAY_CAL_ID);
  
  // 2. ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ (ì•ˆì „ì„ ìœ„í•´ ìµœê·¼ 200ì¤„ë¡œ ë²”ìœ„ í™•ì¥)
  const lastRow = sheet.getLastRow();
  const startRow = 2; // í—¤ë” ì œì™¸ 2í–‰ë¶€í„°
  const numRows = lastRow - 1;
  if (numRows <= 0) return;

  const range = sheet.getRange(startRow, 1, numRows, 35); 
  const values = range.getValues();

  let weatherCount = 0;
  let naverCount = 0;

  for (let i = 0; i < values.length; i++) {
    let rawDate = values[i][0];
    if (!rawDate) continue;

    // [ê°•í™”ëœ ë‚ ì§œ ì •ê·œí™”] ì–´ë–¤ í˜•ì‹ì´ë“  yyyy-MM-dd ë¬¸ìì—´ë¡œ ê°•ì œ ë³€í™˜
    let dStr = "";
    try {
      if (rawDate instanceof Date) {
        dStr = Utilities.formatDate(rawDate, "GMT+9", "yyyy-MM-dd");
      } else {
        // í…ìŠ¤íŠ¸(2026.01.20 ë“±)ì¼ ê²½ìš° ìˆ«ìë§Œ ì¶”ì¶œí•´ì„œ yyyy-MM-ddë¡œ ì¬êµ¬ì„±
        let clean = String(rawDate).replace(/[^0-9]/g, ""); 
        if (clean.length >= 8) {
          dStr = clean.substring(0,4) + "-" + clean.substring(4,6) + "-" + clean.substring(6,8);
        }
      }
    } catch(e) { continue; }

    if (!dStr) continue;

    // A. ë‚ ì”¨ ì •ë³´ ë§¤ì¹­ (O:14, W:22, X:23)
    const wMatch = weatherData.find(item => item.tm === dStr);
    if (wMatch) { 
      values[i][14] = wMatch.avgTa; // í‰ê· ê¸°ì˜¨
      values[i][22] = wMatch.maxTa; // ìµœê³ ê¸°ì˜¨
      values[i][23] = wMatch.sumRn || 0; // ê°•ìˆ˜ëŸ‰
      weatherCount++;
    }
    
    // B. ì „ì¼ëŒ€ë¹„ ê¸°ì˜¨ì°¨ (P:15)
    if (i > 0 && values[i][14] !== "" && values[i-1][14] !== "") {
      values[i][15] = (Number(values[i][14]) - Number(values[i-1][14])).toFixed(1);
    }

    // C. ê¸´ê¸‰ë„ ì§€í‘œ (T:19) ìë™ ê³„ì‚°
    let freeIbSum = Number(values[i][5] || 0) + Number(values[i][10] || 0);
    let emergencySum = Number(values[i][20] || 0) + Number(values[i][21] || 0);
    values[i][19] = freeIbSum > 0 ? (emergencySum / freeIbSum).toFixed(2) : 0;

      // D. ë„¤ì´ë²„ íŠ¸ë Œë“œ ë§¤ì¹­ (Y:24 ~ AD:29)
    const nMatch = naverData.find(item => item.period === dStr);
    if (nMatch && nMatch.ratios) {
      // ì´ì œ ratios ë°°ì—´ì— 6ê°œì˜ ë°ì´í„°ê°€ ë“¤ì–´ìˆìœ¼ë¯€ë¡œ ëª¨ë‘ ì‹œíŠ¸ì— ì ì¬í•©ë‹ˆë‹¤.
      nMatch.ratios.forEach((r, idx) => { 
        if (idx < 6) values[i][24 + idx] = r; 
      });
      naverCount++;
    }

    // E. ê³µíœ´ì¼ ì •ë³´ (AE:30)
    if (holidayCal) {
      try {
        const dateObj = (rawDate instanceof Date) ? rawDate : new Date(dStr);
        const events = holidayCal.getEventsForDay(dateObj);
        values[i][30] = events.length > 0 ? events.map(h => h.getTitle()).join(", ") : "";
      } catch(e) {}
    }
  }
  
  // 3. ì‹œíŠ¸ ë°˜ì˜
  range.setValues(values);
  SpreadsheetApp.getUi().alert(`âœ… ë™ê¸°í™” ì™„ë£Œ!\n- ë‚ ì”¨ ì—…ë°ì´íŠ¸: ${weatherCount}ê±´\n- íŠ¸ë Œë“œ ì—…ë°ì´íŠ¸: ${naverCount}ê±´`);
}

function fetchWeatherDataRange(start, end) {
  const url = `http://apis.data.go.kr/1360000/AsosDalyInfoService/getWthrDataList?serviceKey=${encodeURIComponent(WEATHER_SERVICE_KEY)}&numOfRows=900&pageNo=1&dataCd=ASOS&dateCd=DAY&startDt=${start}&endDt=${end}&stnIds=108&dataType=JSON`;
  try {
    const res = UrlFetchApp.fetch(url, { "muteHttpExceptions": true });
    const resJson = JSON.parse(res.getContentText());
    return resJson.response.body.items.item || [];
  } catch (e) { console.log("Weather API Error"); return []; }
}

/**
 * [V15.4] ë„¤ì´ë²„ íŠ¸ë Œë“œ ë°ì´í„° ìˆ˜ì§‘ - ê° ê·¸ë£¹ë³„ ê°œë³„ 100 ê¸°ì¤€(ì •ê·œí™”) ë¡œì§
 */
function fetchNaverTrendRange(start, end) {
  const url = "https://openapi.naver.com/v1/datalab/search";
  let mergedResults = [];
  
  // ê° í‚¤ì›Œë“œ ê·¸ë£¹ì„ í•˜ë‚˜ì”© ë…ë¦½ì ìœ¼ë¡œ í˜¸ì¶œ (ê·¸ë£¹ë³„ ê°œë³„ 100 ê¸°ì¤€ í™•ë³´)
  for (let i = 0; i < NAVER_KEYWORD_GROUPS.length; i++) {
    const singleGroup = [NAVER_KEYWORD_GROUPS[i]];
    const payload = { 
      "startDate": start, 
      "endDate": end, 
      "timeUnit": "date", 
      "keywordGroups": singleGroup 
    };
    const options = { 
      "method": "post", "contentType": "application/json", 
      "headers": { 
        "X-Naver-Client-Id": NAVER_CLIENT_ID, 
        "X-Naver-Client-Secret": NAVER_CLIENT_SECRET 
      },
      "payload": JSON.stringify(payload), 
      "muteHttpExceptions": true 
    };

    try {
      const res = UrlFetchApp.fetch(url, options);
      const json = JSON.parse(res.getContentText());
      
      if (json.results && json.results[0].data) {
        // ì²« ë²ˆì§¸ ê·¸ë£¹ í˜¸ì¶œ ì‹œ ë‚ ì§œ(period) í‹€ ìƒì„±
        if (mergedResults.length === 0) {
          json.results[0].data.forEach(d => mergedResults.push({ period: d.period, ratios: [] }));
        }
        
        // í•´ë‹¹ ê·¸ë£¹ì˜ ë°ì´í„°ë¥¼ ë‚ ì§œë³„ë¡œ ë§¤ì¹­í•˜ì—¬ ratios ë°°ì—´ì— ì¶”ê°€
        json.results[0].data.forEach((d, dIdx) => {
          if (mergedResults[dIdx]) {
            mergedResults[dIdx].ratios.push(d.ratio);
          }
        });
      }
    } catch (e) {
      console.log(`${NAVER_KEYWORD_GROUPS[i].groupName} ê·¸ë£¹ í˜¸ì¶œ ì¤‘ ì—ëŸ¬ ë°œìƒ`);
    }
  }
  return mergedResults;
}

/**
 * [BigQuery] ë°ì´í„° ì—°ë™ ê³µí†µ í•¨ìˆ˜
 */
function runBQQuery(sql, projectId) {
  try {
    const queryResults = BigQuery.Jobs.query({ query: sql, useLegacySql: false }, projectId);
    return queryResults.rows ? queryResults.rows.map(row => row.f.map(col => col.v)) : [];
  } catch (e) { return []; }
}

function fetchRelatedNews(startDate, endDate) {
  const query = encodeURIComponent("ì„¸ìŠ¤ì½” OR ë°©ì—­ OR í•´ì¶© OR ë¹ˆëŒ€ OR ê¸°í›„ë³€í™”");
  const url = `https://openapi.naver.com/v1/search/news.json?query=${query}&display=50&sort=date`;
  
  const options = {
    "headers": {
      "X-Naver-Client-Id": NAVER_CLIENT_ID,
      "X-Naver-Client-Secret": NAVER_CLIENT_SECRET
    },
    "muteHttpExceptions": true
  };

  try {
    const response = UrlFetchApp.fetch(url, options);
    const items = JSON.parse(response.getContentText()).items;
    
    // ë¶„ì„ ê¸°ê°„(ì›”~ì¼)ì— í•´ë‹¹í•˜ëŠ” ë‰´ìŠ¤ë§Œ í•„í„°ë§
    const start = new Date(startDate + "T00:00:00");
    const end = new Date(endDate + "T23:59:59");
    
    return items
      .filter(item => {
        const pubDate = new Date(item.pubDate);
        return pubDate >= start && pubDate <= end;
      })
      .map(item => ({
        title: item.title.replace(/<[^>]*>?/gm, ''), // HTML íƒœê·¸ ì œê±°
        link: item.link,
        date: Utilities.formatDate(new Date(item.pubDate), "GMT+9", "MM-dd")
      }))
      .slice(0, 8); // ìƒìœ„ 8ê°œë§Œ ë°˜í™˜
  } catch (e) {
    console.error("News Fetch Error: " + e.toString());
    return [];
  }
}


/**
 * [ë³µêµ¬] ê³ í’ˆê²© ë¦¬í¬íŠ¸ UI í…œí”Œë¦¿ (MTD/ì£¼ê°„ ë¹„êµí‘œ ë° ë””ìì¸ ê°•í™”)
 */
/**
 * [V15.9] ì£¼ê°„ ë¹„êµí‘œ(Table 2)ê°€ ì¶”ê°€ëœ ê³ í’ˆê²© ë¦¬í¬íŠ¸ UI í…œí”Œë¦¿
 */
function getEmailTemplate(d, cur, pre, old, mtd, mtdOld, aiContent, newsList) {
  const pct = (c, p) => {
    if (!p || p === 0) return "0.0%";
    const val = ((c - p) / p * 100).toFixed(1);
    const color = val >= 0 ? "#d93025" : "#1967d2"; // ìƒìŠ¹ì€ ë¹¨ê°•, í•˜ë½ì€ íŒŒë‘
    return `<span style="color:${color}; font-weight:bold;">${val >= 0 ? 'â–²' : 'â–¼'}${Math.abs(val)}%</span>`;
  };

  const newsHtml = newsList.length > 0 
    ? newsList.map(n => `<li style="margin-bottom:6px; font-size:13px;">[${n.date}] <a href="${n.link}" target="_blank" style="color:#0b5394; text-decoration:none;">${n.title}</a></li>`).join("")
    : "<li style='color:#999;'>ë¶„ì„ ê¸°ê°„ ë‚´ ì£¼ìš” ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</li>";

  return `
    <div style="font-family: 'Malgun Gothic', sans-serif; max-width: 800px; margin: auto; padding: 20px; border: 1px solid #eee; color: #333;">
      <header style="border-bottom: 3px solid #0b5394; padding-bottom: 10px; margin-bottom: 20px;">
        <h2 style="color: #0b5394; margin: 0;">ğŸ“Š ì„¸ìŠ¤ì½” í†µí•© ë§ˆì¼€íŒ… ì„±ê³¼ ë¶„ì„ ë¦¬í¬íŠ¸</h2>
        <p style="margin: 5px 0 0 0; font-size: 13px; color: #666;">ë¶„ì„ ê¸°ê°„: ${d.cur.start} ~ ${d.cur.end}</p>
      </header>

      <section style="margin-bottom: 30px;">
        <h4 style="background: #f8f9fa; padding: 8px; border-left: 4px solid #0b5394; margin-bottom: 10px;">1. ì „ë…„ ëŒ€ë¹„ ì›”ê°„ ëˆ„ì  ë¹„êµ (MTD)</h4>
        <table border="1" style="border-collapse: collapse; width: 100%; text-align: center; font-size: 12px; border-color: #ddd;">
          <tr style="background: #f3f3f3; font-weight: bold;">
            <th style="padding: 10px;">êµ¬ë¶„</th><th>í™ˆí˜ì´ì§€ DB<br>(ì¹´ì¹´ì˜¤í¬í•¨)</th><th>ê¸´ê¸‰ì§„ë‹¨</th><th>í™ˆí˜ì´ì§€+ê¸´ê¸‰<br>í•©ê³„</th><th>IB ì½œ</th><th>ì „ì²´ ì‹ ì²­</th>
          </tr>
          <tr>
            <td style="padding: 10px; background: #fff;">ë‹¹ì›” ëˆ„ì </td>
            <td>${mtd.webDbInclKakao}</td><td>${mtd.emergency}</td><td style="font-weight:bold;">${mtd.webEmSum}</td><td>${mtd.callIb}</td><td>${mtd.total}</td>
          </tr>
          <tr>
            <td style="padding: 10px; background: #fff;">ì „ë…„ ëˆ„ì </td>
            <td>${mtdOld.webDbInclKakao}</td><td>${mtdOld.emergency}</td><td style="font-weight:bold;">${mtdOld.webEmSum}</td><td>${mtdOld.callIb}</td><td>${mtdOld.total}</td>
          </tr>
          <tr style="background: #fdfdfd;">
            <td style="padding: 10px; font-weight: bold;">ì¦ê°(%)</td>
            <td>${pct(mtd.webDbInclKakao, mtdOld.webDbInclKakao)}</td><td>${pct(mtd.emergency, mtdOld.emergency)}</td><td>${pct(mtd.webEmSum, mtdOld.webEmSum)}</td><td>${pct(mtd.callIb, mtdOld.callIb)}</td><td>${pct(mtd.total, mtdOld.total)}</td>
          </tr>
        </table>
      </section>

      <section style="margin-bottom: 30px;">
        <h4 style="background: #f8f9fa; padding: 8px; border-left: 4px solid #0b5394; margin-bottom: 10px;">2. ì „ë…„/ì „ì£¼ ëŒ€ë¹„ ì£¼ê°„ ìˆ˜ì¹˜ ë¹„êµ</h4>
        <table border="1" style="border-collapse: collapse; width: 100%; text-align: center; font-size: 11px; border-color: #ddd;">
          <tr style="background: #f3f3f3; font-weight: bold;">
            <th style="padding: 8px;">êµ¬ë¶„</th><th>í™ˆí˜ì´ì§€ DB<br>(ì¹´ì¹´ì˜¤í¬í•¨)</th><th>ê¸´ê¸‰ì§„ë‹¨</th><th>í™ˆí˜ì´ì§€+ê¸´ê¸‰<br>í•©ê³„</th><th>IB ì½œ</th><th>ì „ì²´ ì‹ ì²­</th>
          </tr>
          <tr>
            <td style="padding: 8px; background: #fff;">ê¸ˆì£¼ (${d.cur.start})</td>
            <td>${cur.webDbInclKakao}</td><td>${cur.emergency}</td><td style="font-weight:bold;">${cur.webEmSum}</td><td>${cur.callIb}</td><td>${cur.total}</td>
          </tr>
          <tr>
            <td style="padding: 8px; background: #fff;">ì „ë…„ ë™ìš”ì¼ (${d.year.start})</td>
            <td>${old.webDbInclKakao}</td><td>${old.emergency}</td><td>${old.webEmSum}</td><td>${old.callIb}</td><td>${old.total}</td>
          </tr>
          <tr style="background: #fdfdfd; font-weight: bold;">
            <td style="padding: 8px;">ì „ë…„ ëŒ€ë¹„ (%)</td>
            <td>${pct(cur.webDbInclKakao, old.webDbInclKakao)}</td><td>${pct(cur.emergency, old.emergency)}</td><td>${pct(cur.webEmSum, old.webEmSum)}</td><td>${pct(cur.callIb, old.callIb)}</td><td>${pct(cur.total, old.total)}</td>
          </tr>
          <tr>
            <td style="padding: 8px; background: #fff;">ì „ì£¼ (${d.prev.start})</td>
            <td>${pre.webDbInclKakao}</td><td>${pre.emergency}</td><td>${pre.webEmSum}</td><td>${pre.callIb}</td><td>${pre.total}</td>
          </tr>
          <tr style="background: #fdfdfd; font-weight: bold;">
            <td style="padding: 8px;">ì „ì£¼ ëŒ€ë¹„ (%)</td>
            <td>${pct(cur.webDbInclKakao, pre.webDbInclKakao)}</td><td>${pct(cur.emergency, pre.emergency)}</td><td>${pct(cur.webEmSum, pre.webEmSum)}</td><td>${pct(cur.callIb, pre.callIb)}</td><td>${pct(cur.total, pre.total)}</td>
          </tr>
        </table>
      </section>

      <section style="margin-bottom: 30px;">
        <h4 style="background: #f8f9fa; padding: 8px; border-left: 4px solid #0b5394; margin-bottom: 10px;">3. ë°ì´í„° ê¸°ë°˜ ì „ëµ ì¸ê³¼ê´€ê³„ ë¶„ì„</h4>
        <div style="line-height: 1.8; font-size: 14px; background: #fcfcfc; padding: 20px; border-radius: 5px; border: 1px solid #eee;">
          ${aiContent}
        </div>
      </section>

      <section>
        <h4 style="background: #f8f9fa; padding: 8px; border-left: 4px solid #0b5394; margin-bottom: 10px;">4. ë¶„ì„ ê¸°ê°„ ë‚´ ì£¼ìš” ì™¸ë¶€ ì´ìŠˆ</h4>
        <ul style="padding-left: 20px; margin: 0;">
          ${newsHtml}
        </ul>
      </section>

      <footer style="margin-top: 40px; padding-top: 10px; border-top: 1px solid #eee; font-size: 11px; color: #999; text-align: center;">
        ë³¸ ë¦¬í¬íŠ¸ëŠ” ì„¸ìŠ¤ì½” ë””ì§€í„¸ ë§ˆì¼€íŒ… ëŒ€ì‹œë³´ë“œ AI ì—”ì§„ì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
      </footer>
    </div>
  `;
}

function testKey() {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
  const payload = { "contents": [{ "parts": [{ "text": "ì•ˆë…•" }] }] };
  const options = { "method": "post", "contentType": "application/json", "payload": JSON.stringify(payload), "muteHttpExceptions": true };
  
  const res = UrlFetchApp.fetch(url, options);
  const code = res.getResponseCode();
  const text = res.getContentText();
  
  if (code === 200) {
    SpreadsheetApp.getUi().alert("âœ… API í‚¤ê°€ ì •ìƒì…ë‹ˆë‹¤! ëª¨ë¸ë„ ì˜ ì‘ë™í•´ìš”.");
  } else {
    SpreadsheetApp.getUi().alert("âŒ ì—ëŸ¬ ë°œìƒ! \nì‘ë‹µ ì½”ë“œ: " + code + "\nìƒì„¸ ë‚´ìš©: " + text);
  }
}
