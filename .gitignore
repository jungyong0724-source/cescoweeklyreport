/**
 * ì„¸ìŠ¤ì½” í†µí•© ë§ˆì¼€íŒ… ëŒ€ì‹œë³´ë“œ & ìê°€ í•™ìŠµ AI ë¦¬í¬íŠ¸ (V10.0)
 * 2026ë…„ ê¸°ì¤€ | ì „ë…„ ë™ìš”ì¼ ë¹„êµ | ì¹´ì¹´ì˜¤ ì‹¤ì  í†µí•© | í”¼ë“œë°± ê¸°ë°˜ ìŠ¤íƒ€ì¼ í•™ìŠµ ê¸°ëŠ¥
 */

function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('AI ë³´ê³ ì„œ ê´€ë¦¬')
      .addItem('ì „ì²´ ë°ì´í„° ë™ê¸°í™” ì—…ë°ì´íŠ¸ (ì „ì²´ ë°˜ì˜)', 'updateAllData')
      .addSeparator()
      .addItem('ë°ì´í„° ì—…ë°ì´íŠ¸ (ë‚ ì”¨/ë„¤ì´ë²„/ì´ìŠˆ/ì§€í‘œ)', 'updateExternalData')
      .addItem('ì„œì¹˜ì½˜ì†” ì£¼ê°„ë¹„êµ ì—…ë°ì´íŠ¸ (BQ)', 'updateGSCWeeklyData')
      .addItem('GA4 ë‚´ë¶€ê²€ìƒ‰ì–´ ì£¼ê°„ë¹„êµ ì—…ë°ì´íŠ¸ (BQ)', 'updateGA4WeeklyData')
      .addItem('GA4 í•µì‹¬í˜ì´ì§€ ìœ ì…ë¶„ì„ (BQ)', 'updateGA4InboundWeeklyData')
      .addSeparator()
      .addItem('ì§€ë‚œì£¼ HTML ë³´ê³ ì„œ ìƒˆë¡­ê²Œ ì‘ì„±í•˜ê¸°', 'generateWeeklyReport')
      .addItem('ì‘ì„±ëœ ë³´ê³ ì„œ ë‹¤ì‹œ ë¯¸ë¦¬ë³´ê¸°', 'showSavedReportPreview')
      .addToUi();
}

// [í™˜ê²½ ì„¤ì •ê°’]
const GEMINI_API_KEY = 'AIzaSyCF53ValPixwybusoKfwuYwoUkFGFkSMxY';
const NAVER_CLIENT_ID = 'ugxntcbaOqIuh_3y_uLv';
const NAVER_CLIENT_SECRET = 'Hoqaso5G2k';
const WEATHER_SERVICE_KEY = 'BNgXBXi+SL3VYIsQPruhshx9i37x/I/K6S5AFyd+cpu6wzvCjfZTgzu1MYazUfvVcj3wS8O1kZGADjOYUsN++A==';
const BQ_PROJECT_ID = 'cescojungyong';
const GA4_PROJECT_ID = 'cescomall-405900';
const GA4_DATASET_ID = 'analytics_335040662';
const HOLIDAY_CAL_ID = 'ko.south_korea#holiday@group.v.calendar.google.com';

const NAVER_KEYWORD_GROUPS = [
  { groupName: "ì„¸ìŠ¤ì½”", keywords: ["ì„¸ìŠ¤ì½”", "CESCO"] },
  { groupName: "í•´ì¶©", keywords: ["ë°”í€´ë²Œë ˆ", "ê°œë¯¸", "ë¹ˆëŒ€", "ì¥", "ë²¼ë£©"] },
  { groupName: "ë°©ì—­ë¹„ìš©", keywords: ["ì„¸ìŠ¤ì½” ë¹„ìš©", "ì„¸ìŠ¤ì½” ê°€ê²©", "ë°©ì—­ ì—…ì²´ ë¹„ìš©", "ë°”í€´ë²Œë ˆ í‡´ì¹˜ ë¹„ìš©"] },
  { groupName: "ë¹„ì¦ˆë‹ˆìŠ¤ìœ„ìƒ", keywords: ["ì‹ë‹¹ ë°©ì—­", "HACCP", "í•´ì¹ ì¸ì¦", "ì‹í’ˆìœ„ìƒë²•", "ì˜ì—…ì •ì§€ ìœ„ìƒ"] },
  { groupName: "ì´ì‚¬ë°©ì—­", keywords: ["ì´ì‚¬ ë°©ì—­", "ì…ì£¼ ë°©ì—­", "ìƒˆì§‘ì¦í›„êµ°", "ë¨¼ì§€ë‹¤ë“¬ì´"] },
  { groupName: "ë°©ì—­ë¹„êµ", keywords: ["ë Œí† í‚¬", "í„°ë¯¸ë‹‰ìŠ¤", "ë°©ì—­ì—…ì²´ ì¶”ì²œ", "ë™ë„¤ ë°©ì—­"] }
];

/**
 * [ë‚ ì§œ ì—”ì§„] 2026ë…„ ê¸°ì¤€ ì „ë…„ ë™ìš”ì¼(364ì¼ ì „) ê³„ì‚°
 */
function getReportingPeriods() {
  const today = new Date(); 
  const dayOfWeek = today.getDay();
  const diffToLastMon = (dayOfWeek === 0 ? 6 : dayOfWeek - 1) + 7;
  const curStart = new Date(today.getTime() - diffToLastMon * 24 * 60 * 60 * 1000);
  const curEnd = new Date(curStart.getTime() + 6 * 24 * 60 * 60 * 1000);
  const prevStart = new Date(curStart.getTime() - 7 * 24 * 60 * 60 * 1000);
  const prevEnd = new Date(curEnd.getTime() - 7 * 24 * 60 * 60 * 1000);
  const yearStart = new Date(curStart.getTime() - 364 * 24 * 60 * 60 * 1000);
  const yearEnd = new Date(curEnd.getTime() - 364 * 24 * 60 * 60 * 1000);
  const mtdStart = new Date(curEnd.getFullYear(), curEnd.getMonth(), 1);
  const mtdOldStart = new Date(mtdStart.getTime() - 364 * 24 * 60 * 60 * 1000);

  const f = (d) => Utilities.formatDate(d, "GMT+9", "yyyy-MM-dd");
  const fbq = (d) => Utilities.formatDate(d, "GMT+9", "yyyyMMdd");
  return {
    cur: { start: f(curStart), end: f(curEnd), bq: fbq(curStart), bqEnd: fbq(curEnd) },
    prev: { start: f(prevStart), end: f(prevEnd) },
    year: { start: f(yearStart), end: f(yearEnd) },
    mtd: { start: f(mtdStart), end: f(curEnd) },
    mtdYear: { start: f(mtdOldStart), end: f(yearEnd) }
  };
}

/**
 * [ë°ì´í„° ì—”ì§„] ì¹´ì¹´ì˜¤ í¬í•¨ ìˆ˜ì¹˜ ì •ë°€ ì§‘ê³„
 */
function getPeriodStatsExtended(sheet, startStr, endStr) {
  const data = sheet.getDataRange().getValues();
  let res = { 
    total:0, webDbInclKakao:0, emergency:0, webEmSum:0, callIb:0,
    home:0, rest:0, biz:0, etc:0, 
    avgTemp:0, urgencyIndex:0, trendPest:0, trendCesco:0, issues:[], count:0 
  };

  for (let i = 1; i < data.length; i++) {
    let dStr = (data[i][0] instanceof Date) ? Utilities.formatDate(data[i][0], "GMT+9", "yyyy-MM-dd") : String(data[i][0]);
    if (dStr >= startStr && dStr <= endStr) {
      let dailyWebWithKakao = Number(data[i][5]||0) + Number(data[i][17]||0) + Number(data[i][18]||0);
      let dailyEmergency = Number(data[i][20]||0) + Number(data[i][21]||0);
      res.webDbInclKakao += dailyWebWithKakao;
      res.emergency += dailyEmergency;
      res.webEmSum += (dailyWebWithKakao + dailyEmergency);
      res.callIb += Number(data[i][10]||0);
      res.total += Number(data[i][11]||0);
      res.home += (Number(data[i][1]||0) + Number(data[i][6]||0) + Number(data[i][17]||0) + Number(data[i][20]||0));
      res.rest += (Number(data[i][2]||0) + Number(data[i][7]||0) + Number(data[i][18]||0) + Number(data[i][21]||0));
      res.biz  += (Number(data[i][3]||0) + Number(data[i][8]||0));
      res.etc  += (Number(data[i][4]||0) + Number(data[i][9]||0));
      res.avgTemp += Number(data[i][14]||0); 
      res.trendCesco += Number(data[i][24]||0);
      res.trendPest += Number(data[i][25]||0);
      res.urgencyIndex += Number(data[i][19]||0);
      if (data[i][31]) res.issues.push(data[i][31]);
      res.count++;
    }
  }
  if(res.count > 0) {
    res.avgTemp = (res.avgTemp / res.count).toFixed(1);
    res.urgencyIndex = (res.urgencyIndex / res.count).toFixed(2);
    res.trendCesco = (res.trendCesco / res.count).toFixed(1);
    res.trendPest = (res.trendPest / res.count).toFixed(1);
  }
  res.issues = [...new Set(res.issues)].join(" / ");
  return res;
}

/**
 * [Main] í•™ìŠµí˜• ë³´ê³ ì„œ ì‘ì„± ê¸°ëŠ¥
 */
function generateWeeklyReport() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dataSheet = ss.getSheetByName('2_ë¡œë°ì´í„°');
  const ga4InboundSheet = ss.getSheetByName('GA4ìœ ì…í‚¤ì›Œë“œ');
  let reportSheet = ss.getSheetByName('ë³´ê³ ì‹œíŠ¸') || ss.insertSheet('ë³´ê³ ì‹œíŠ¸');
  
  const d = getReportingPeriods();
  const cur = getPeriodStatsExtended(dataSheet, d.cur.start, d.cur.end);
  const pre = getPeriodStatsExtended(dataSheet, d.prev.start, d.prev.end);
  const old = getPeriodStatsExtended(dataSheet, d.year.start, d.year.end);
  const mtd = getPeriodStatsExtended(dataSheet, d.mtd.start, d.mtd.end);
  const mtdOld = getPeriodStatsExtended(dataSheet, d.mtdYear.start, d.mtdYear.end);
  
  const newsList = fetchRelatedNews(d.cur.start, d.cur.end);
  const newsContext = newsList.map(n => `[${n.date}] ${n.title}`).join("\n");
  const bestPractices = getBestPractices(); // ê³¼ê±° ì¢‹ì•„ìš” ë¶„ì„ ì‚¬ë¡€ ë¶ˆëŸ¬ì˜¤ê¸°

  // 1. ì‹œíŠ¸ í‘œ ì—…ë°ì´íŠ¸ (B2~)
  reportSheet.clear();
  const pct = (c, p) => p > 0 ? ((c-p)/p*100).toFixed(1) + "%" : "-";
  const header = [["êµ¬ë¶„", "í™ˆí˜ì´ì§€ DB(ì¹´ì¹´ì˜¤ í¬í•¨)", "ê¸´ê¸‰ì§„ë‹¨", "í™ˆí˜ì´ì§€+ê¸´ê¸‰ í•©ê³„", "IB ì½œ", "ì „ì²´ ì‹ ì²­(L)"]];
  
  reportSheet.getRange("B2").setValue("1. ì „ë…„ ëŒ€ë¹„ ì›”ê°„ ëˆ„ì  ìˆ˜ì¹˜ ë¹„êµ (MTD)").setFontWeight("bold");
  reportSheet.getRange("B3:G3").setValues(header).setBackground("#0b5394").setFontColor("white");
  reportSheet.getRange("B4:G6").setValues([
    ["ë‹¹ì›” ëˆ„ì ", mtd.webDbInclKakao, mtd.emergency, mtd.webEmSum, mtd.callIb, mtd.total],
    ["ì „ë…„ ëˆ„ì ", mtdOld.webDbInclKakao, mtdOld.emergency, mtdOld.webEmSum, mtdOld.callIb, mtdOld.total],
    ["ì¦ê°(%)", pct(mtd.webDbInclKakao, mtdOld.webDbInclKakao), pct(mtd.emergency, mtdOld.emergency), pct(mtd.webEmSum, mtdOld.webEmSum), pct(mtd.callIb, mtdOld.callIb), pct(mtd.total, mtdOld.total)]
  ]).setHorizontalAlignment("center").setBorder(true,true,true,true,true,true);
  reportSheet.getRange("B6:G6").setFontWeight("bold").setFontColor("red");

  reportSheet.getRange("B8").setValue("2. ì „ë…„/ì „ì£¼ ëŒ€ë¹„ ì£¼ê°„ ìˆ˜ì¹˜ ë¹„êµ").setFontWeight("bold");
  reportSheet.getRange("B9:G9").setValues(header).setBackground("#0b5394").setFontColor("white");
  reportSheet.getRange("B10:G14").setValues([
    [`ê¸ˆì£¼ (${d.cur.start})`, cur.webDbInclKakao, cur.emergency, cur.webEmSum, cur.callIb, cur.total],
    [`ì „ë…„ ë™ìš”ì¼ (${d.year.start})`, old.webDbInclKakao, old.emergency, old.webEmSum, old.callIb, old.total],
    ["ì „ë…„ ëŒ€ë¹„ (%)", pct(cur.webDbInclKakao, old.webDbInclKakao), pct(cur.emergency, old.emergency), pct(cur.webEmSum, old.webEmSum), pct(cur.callIb, old.callIb), pct(cur.total, old.total)],
    [`ì „ì£¼ (${d.prev.start})`, pre.webDbInclKakao, pre.emergency, pre.webEmSum, pre.callIb, pre.total],
    ["ì „ì£¼ ëŒ€ë¹„ (%)", pct(cur.webDbInclKakao, pre.webDbInclKakao), pct(cur.emergency, pre.emergency), pct(cur.webEmSum, pre.webEmSum), pct(cur.callIb, pre.callIb), pct(cur.total, pre.total)]
  ]).setHorizontalAlignment("center").setBorder(true,true,true,true,true,true);

  // 2. AI ë¶„ì„ ë¦¬í¬íŠ¸ ìƒì„± (í•™ìŠµ ë°ì´í„° í¬í•¨)
  const prompt = `
    ë‹¹ì‹ ì€ ì„¸ìŠ¤ì½” ì‹œë‹ˆì–´ ì „ëµê°€ì…ë‹ˆë‹¤. ì•„ë˜ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¸ê³¼ê´€ê³„ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.
    
    [ì¤‘ìš”: ë§ˆì¼€í„° í•™ìŠµ ë°ì´í„°]
    ì•„ë˜ëŠ” ì‚¬ìš©ìê°€ ì´ì „ì— ë§Œì¡±í–ˆë˜ ë¶„ì„ ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤. ì´ì™€ ìœ ì‚¬í•œ ë…¼ë¦¬ êµ¬ì¡°ë¡œ ì‘ì„±í•˜ì„¸ìš”:
    ${bestPractices}

    [ë°ì´í„° ì»¨í…ìŠ¤íŠ¸]
    - ê¸°ê°„: ê¸ˆì£¼(${d.cur.start}), ì „ì£¼(${d.prev.start}), ì „ë…„(${d.year.start})
    - ì „ì²´ ì‹¤ì (ê¸ˆ/ì „/ì‘): ${cur.total} / ${pre.total} / ${old.total}
    - í†µí•© ì—…ì¢…(ê°€ì •/ìš”ì‹/ì‚¬ì—…ì²´): 
        * ê¸ˆì£¼: ${cur.home} / ${cur.rest} / ${cur.biz}
        * ì „ì£¼: ${pre.home} / ${pre.rest} / ${pre.biz}
        * ì „ë…„: ${old.home} / ${old.rest} / ${old.biz}
    - ê¸°ì˜¨ì°¨(WoW/YoY): ${(cur.avgTemp-pre.avgTemp).toFixed(1)}ë„ / ${(cur.avgTemp-old.avgTemp).toFixed(1)}ë„
    - íŠ¸ë Œë“œì§€ìˆ˜: ê¸ˆì£¼ ${cur.trendPest} (ì „ì£¼ë¹„:${(cur.trendPest-pre.trendPest).toFixed(1)}p)
    - ë‰´ìŠ¤: ${newsContext}

    [ì‘ì„±ê·œì¹™] HTML ì „ìš©(ë§ˆí¬ë‹¤ìš´ ê¸ˆì§€). í•­ëª©ë³„ ê°€~ë¼ ëª©ì°¨ ì¤€ìˆ˜. 3ë²ˆ ì¸ì‚¬ì´íŠ¸ í•„ìˆ˜.
  `;

  const aiAnalysis = callGemini(prompt).replace(/\*\*/g, ""); 
  const finalHtml = getEmailTemplate(d, cur, pre, old, mtd, mtdOld, aiAnalysis, newsList);

  reportSheet.getRange("B30").setValue(finalHtml);
  showSavedReportPreview();
}

/**
 * [Feedback] ë§ˆì¼€í„° ë°˜ì‘ ì €ì¥ í•¨ìˆ˜
 */
function saveFeedback(type, section, content) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName('í”¼ë“œë°±_ë¡œê·¸') || ss.insertSheet('í”¼ë“œë°±_ë¡œê·¸');
  if (sheet.getLastRow() === 0) sheet.appendRow(["ë‚ ì§œ", "í‰ê°€", "í•­ëª©", "ë‚´ìš©"]);
  sheet.appendRow([new Date(), type, section, content]);
  return "ê°ì‚¬í•©ë‹ˆë‹¤! ë¶„ì„ ì—”ì§„ì´ í•´ë‹¹ ìŠ¤íƒ€ì¼ì„ í•™ìŠµí–ˆìŠµë‹ˆë‹¤.";
}

/**
 * [Few-Shot] ì„±ê³µ ì‚¬ë¡€ ì¶”ì¶œ
 */
function getBestPractices() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('í”¼ë“œë°±_ë¡œê·¸');
  if (!sheet || sheet.getLastRow() < 2) return "ì•„ì§ í•™ìŠµëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ë¶„ì„ì„ ìˆ˜í–‰í•˜ì„¸ìš”.";
  const data = sheet.getRange(2, 2, sheet.getLastRow()-1, 3).getValues();
  return data.filter(r => r[0] === "LIKE").slice(-3).map(r => `[ì¢‹ì•˜ë˜ ì˜ˆì‹œ]: ${r[2]}`).join("\n\n");
}

/**
 * [Template] ì¢‹ì•„ìš”/ì‹«ì–´ìš” ë²„íŠ¼ì´ í¬í•¨ëœ HTML ë””ìì¸
 */
function getEmailTemplate(d, cur, pre, old, mtd, mtdOld, aiContent, newsList) {
  const pct = (c, p) => p > 0 ? ((c-p)/p*100).toFixed(1) + "%" : "-";
  let newsHtml = newsList.map(n => `<li style="font-size:13px; margin-bottom:5px;">[${n.date}] <a href="${n.link}" target="_blank" style="color:#0b5394; text-decoration:none;">${n.title}</a></li>`).join("");

  return `
    <div style="font-family: 'Malgun Gothic', sans-serif; padding: 20px; color: #333;">
      <h2 style="color: #0b5394;">ğŸ“Š ë°ì´í„° ë”¥ë‹¤ì´ë¸Œ ì„±ê³¼ ë¶„ì„ ë¦¬í¬íŠ¸</h2>
      <p style="text-align: right; color: #666; font-size: 12px;">ë¶„ì„ê¸°ê°„: ${d.cur.start} ~ ${d.cur.end}</p>

      <table border="1" style="border-collapse: collapse; width: 100%; text-align: center; font-size: 12px; margin-bottom: 20px;">
        <tr style="background-color: #f3f3f3;"><th>êµ¬ë¶„</th><th>í™ˆí˜ì´ì§€ DB<br>(ì¹´ì¹´ì˜¤ í¬í•¨)</th><th>ê¸´ê¸‰ì§„ë‹¨</th><th>í™ˆí˜ì´ì§€+ê¸´ê¸‰ í•©ê³„</th><th>IB ì½œ</th><th>ì „ì²´ ì‹ ì²­(L)</th></tr>
        <tr><td>ë‹¹ì›” ëˆ„ì </td><td>${mtd.webDbInclKakao}</td><td>${mtd.emergency}</td><td><b>${mtd.webEmSum}</b></td><td>${mtd.callIb}</td><td>${mtd.total}</td></tr>
        <tr><td>ì „ë…„ ë™ìš”ì¼</td><td>${mtdOld.webDbInclKakao}</td><td>${mtdOld.emergency}</td><td><b>${mtdOld.webEmSum}</b></td><td>${mtdOld.callIb}</td><td>${mtdOld.total}</td></tr>
        <tr style="color: red; font-weight: bold;"><td>ì¦ê°(%)</td><td>${pct(mtd.webDbInclKakao, mtdOld.webDbInclKakao)}</td><td>${pct(mtd.emergency, mtdOld.emergency)}</td><td>${pct(mtd.webEmSum, mtdOld.webEmSum)}</td><td>${pct(mtd.callIb, mtdOld.callIb)}</td><td>${pct(mtd.total, mtdOld.total)}</td></tr>
      </table>

      <div style="margin-top: 30px; padding: 15px; border-left: 5px solid #0b5394; background-color: #fcfcfc; white-space: pre-wrap; font-size: 14px;">
        <div id="aiAnalysisContent">${aiContent}</div>
        <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px; font-size:12px;">
           ğŸ’¡ ì´ ë¶„ì„ ë‚´ìš©ì´ ë§ˆìŒì— ë“œì‹œë‚˜ìš”? <br>
           <button onclick="sendFeedback('LIKE')" style="background:#e6f4ea; border:1px solid #34a853; border-radius:3px; cursor:pointer;">ğŸ‘ ì¢‹ì•„ìš” (ë¶„ì„ ê³ ë„í™” ë°˜ì˜)</button>
           <button onclick="sendFeedback('DISLIKE')" style="background:#fce8e6; border:1px solid #ea4335; border-radius:3px; cursor:pointer;">ğŸ‘ ë³„ë¡œì˜ˆìš”</button>
           <span id="feedbackMsg" style="margin-left:10px; color:#34a853; font-weight:bold;"></span>
        </div>
      </div>

      <div style="margin-top: 30px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
        <h4 style="margin-top: 0; color: #0b5394;">ğŸ“° ë¶„ì„ ì°¸ê³  ê¸°ê°„ ë‚´ ì£¼ìš” ë‰´ìŠ¤</h4>
        <ul style="margin:0; padding-left:20px;">${newsHtml}</ul>
      </div>

      <div id="qa-section" style="margin-top: 40px; padding: 20px; background-color: #f0f4f8; border-radius: 10px;">
        <h4 style="margin-top: 0; color: #0b5394;">ğŸ¤– ë°ì´í„° ë¶„ì„ê°€ Q&A</h4>
        <div style="display:flex; gap:10px;"><input type="text" id="userQuery" style="flex:1; padding:10px;" placeholder="ì˜ˆ: ì¼ë°˜ì‚¬ì—…ì²´ê°€ ì™œ ëŠ˜ì—ˆì–´?"><button onclick="askQuestion()" style="padding:10px 20px; background:#0b5394; color:white; border:none; cursor:pointer;">ì§ˆë¬¸</button></div>
        <div id="aiResponse" style="margin-top:15px; padding:10px; background:white; display:none; border-left:4px solid #0b5394;"><div id="loader">ë¶„ì„ ì¤‘...</div><div id="answerText"></div></div>
      </div>

      <script>
        function sendFeedback(type) {
          var content = document.getElementById('aiAnalysisContent').innerText;
          google.script.run.withSuccessHandler(function(res) {
            document.getElementById('feedbackMsg').innerText = res;
          }).saveFeedback(type, 'ì „ì²´ë¦¬í¬íŠ¸', content);
        }
        function askQuestion() {
          var query = document.getElementById('userQuery').value;
          document.getElementById('aiResponse').style.display = 'block';
          google.script.run.withSuccessHandler(function(res) {
            document.getElementById('answerText').innerHTML = '<b>A:</b> ' + res;
          }).askAiQuestion(query);
        }
      </script>
    </div>`;
}

// --- í•˜ìœ„ ì§€ì› í•¨ìˆ˜êµ° (API í˜¸ì¶œ ë° ìˆ˜ì§‘) ---
function askAiQuestion(userQuestion) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dataSheet = ss.getSheetByName('2_ë¡œë°ì´í„°');
  const d = getReportingPeriods();
  const cur = getPeriodStatsExtended(dataSheet, d.cur.start, d.cur.end);
  const pre = getPeriodStatsExtended(dataSheet, d.prev.start, d.prev.end);
  const recentNews = fetchRelatedNews(cur.start, cur.end);
  
  const prompt = `ë‹¹ì‹ ì€ ì„¸ìŠ¤ì½” ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. íšŒí”¼í˜• ë‹µë³€ ì—†ì´ ë‹¨ì •ì ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”.
    [ë°ì´í„°] ì‹¤ì : ${cur.total}(ì „ì£¼ ${pre.total}), ê°€ì • ${cur.home}, ìš”ì‹ ${cur.rest}, ì‚¬ì—…ì²´ ${cur.biz}, íŠ¸ë Œë“œ ${cur.trendPest}. 
    [ì§ˆë¬¸]: "${userQuestion}" \në°ì´í„°ì— ê¸°ë°˜í•´ 4ë¬¸ì¥ ë‚´ë¡œ ë‹µë³€í•˜ì„¸ìš”.`;
  return callGemini(prompt);
}

function callGemini(prompt) {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
  const response = UrlFetchApp.fetch(url, { "method": "post", "contentType": "application/json", "payload": JSON.stringify({ "contents": [{ "parts": [{ "text": prompt }] }] }), "muteHttpExceptions": true });
  return JSON.parse(response.getContentText()).candidates[0].content.parts[0].text;
}

function fetchRelatedNews(startDate, endDate) {
  const url = `https://openapi.naver.com/v1/search/news.json?query=${encodeURIComponent("í•´ì¶© ë°©ì—­ ë¹ˆëŒ€ ê¸°í›„ë³€í™”")}&display=50&sort=date`;
  const options = { "method": "get", "headers": { "X-Naver-Client-Id": NAVER_CLIENT_ID, "X-Naver-Client-Secret": NAVER_CLIENT_SECRET } };
  try {
    const items = JSON.parse(UrlFetchApp.fetch(url, options).getContentText()).items;
    const start = new Date(startDate + "T00:00:00"); const end = new Date(endDate + "T23:59:59");
    return items.filter(item => { let p = new Date(item.pubDate); return p >= start && p <= end; })
                .map(item => ({ title: item.title.replace(/<[^>]*>?/gm, ''), link: item.link, date: Utilities.formatDate(new Date(item.pubDate), "GMT+9", "yyyy-MM-dd") }))
                .slice(0, 8);
  } catch (e) { return []; }
}

function showSavedReportPreview() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const reportSheet = ss.getSheetByName('ë³´ê³ ì‹œíŠ¸');
  const savedHtml = reportSheet ? reportSheet.getRange("B30").getValue() : "";
  const htmlOutput = HtmlService.createHtmlOutput(savedHtml).setWidth(950).setHeight(850);
  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'ì„¸ìŠ¤ì½” ë°ì´í„° ë”¥ë¶„ì„ ë¦¬í¬íŠ¸');
}

function updateAllData() {
  const dates = getReportingPeriods();
  updateExternalData();             
  updateGSCWeeklyData(dates);       
  updateGA4WeeklyData(dates);       
  updateGA4InboundWeeklyData(dates); 
}

function updateExternalData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('2_ë¡œë°ì´í„°');
  const today = new Date();
  const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
  const weatherData = fetchWeatherDataRange(Utilities.formatDate(new Date(today.getTime()-30*24*60*60*1000), "GMT+9", "yyyyMMdd"), Utilities.formatDate(yesterday, "GMT+9", "yyyyMMdd"));
  const naverData = fetchNaverTrendRange(Utilities.formatDate(new Date(today.getFullYear()-2, today.getMonth(), today.getDate()), "GMT+9", "yyyy-MM-dd"), Utilities.formatDate(yesterday, "GMT+9", "yyyy-MM-dd"));
  applyDataToSheet(sheet, weatherData, naverData);
}

function applyDataToSheet(sheet, weatherItems, naverItems) {
  const lastRow = sheet.getLastRow();
  const range = sheet.getRange(1, 1, lastRow, 35); 
  const values = range.getValues();
  const holidayCal = CalendarApp.getCalendarById(HOLIDAY_CAL_ID);
  for (let i = 1; i < values.length; i++) {
    let rowDate = values[i][0];
    if (!(rowDate instanceof Date)) continue;
    let dStr = Utilities.formatDate(rowDate, "GMT+9", "yyyy-MM-dd");
    const wMatch = weatherItems.find(item => item.tm === dStr);
    if (wMatch) { values[i][14] = wMatch.avgTa; values[i][22] = wMatch.maxTa; values[i][23] = wMatch.sumRn || 0; }
    if (i > 1 && values[i][14] !== "" && values[i-1][14] !== "") values[i][15] = (values[i][14] - values[i-1][14]).toFixed(1);
    let freeTotal = Number(values[i][5] || 0) + Number(values[i][10] || 0);
    let emergencyTotal = Number(values[i][20] || 0) + Number(values[i][21] || 0);
    values[i][19] = freeTotal > 0 ? (emergencyTotal / freeTotal).toFixed(2) : 0;
    const nMatch = naverItems.find(item => item.period === dStr);
    if (nMatch) nMatch.ratios.forEach((r, idx) => { values[i][24 + idx] = r; });
    values[i][30] = holidayCal.getEventsForDay(rowDate).map(h => h.getTitle()).join(", ");
  }
  range.setValues(values);
}

function runBQQuery(sql, projectId) {
  return BigQuery.Jobs.query({ query: sql, useLegacySql: false }, projectId).rows?.map(row => row.f.map(col => col.v)) || [];
}

function fetchNaverTrendRange(start, end) {
  const url = "https://openapi.naver.com/v1/datalab/search"; const chunks = [];
  for (let i = 0; i < NAVER_KEYWORD_GROUPS.length; i += 5) chunks.push(NAVER_KEYWORD_GROUPS.slice(i, i + 5));
  let merged = [];
  chunks.forEach((chunk, idx) => {
    const res = UrlFetchApp.fetch(url, { "method": "post", "contentType": "application/json", "headers": { "X-Naver-Client-Id": NAVER_CLIENT_ID, "X-Naver-Client-Secret": NAVER_CLIENT_SECRET }, "payload": JSON.stringify({ "startDate": start, "endDate": end, "timeUnit": "date", "keywordGroups": chunk }) });
    const json = JSON.parse(res.getContentText());
    if (json.results) { 
      if (idx === 0) json.results[0].data.forEach(d => merged.push({ period: d.period, ratios: [] }));
      json.results.forEach((g, gIdx) => g.data.forEach(d => { let t = merged.find(r => r.period === d.period); if (t) t.ratios[idx*5+gIdx] = d.ratio; }));
    }
  });
  return merged;
}

function fetchWeatherDataRange(start, end) {
  const url = `http://apis.data.go.kr/1360000/AsosDalyInfoService/getWthrDataList?serviceKey=${encodeURIComponent(WEATHER_SERVICE_KEY)}&numOfRows=400&pageNo=1&dataCd=ASOS&dateCd=DAY&startDt=${start}&endDt=${end}&stnIds=108&dataType=JSON`;
  return JSON.parse(UrlFetchApp.fetch(url).getContentText()).response.body.items.item || [];
}

function updateGSCWeeklyData(dates) {
  const sql = `WITH base AS (SELECT query, clicks, CASE WHEN data_date BETWEEN '${dates.cur.start}' AND '${dates.cur.end}' THEN 'cur' WHEN data_date BETWEEN '${dates.prev.start}' AND '${dates.prev.end}' THEN 'prev' WHEN data_date BETWEEN '${dates.year.start}' AND '${dates.year.end}' THEN 'year' END as period FROM \`${BQ_PROJECT_ID}.searchconsole_cesco.searchdata_site_impression\` WHERE data_date BETWEEN '${dates.year.start}' AND '${dates.cur.end}') SELECT query, CAST(SUM(IF(period = 'cur', clicks, 0)) AS INT64) as cur, CAST(SUM(IF(period = 'prev', clicks, 0)) AS INT64) as prev, CAST(SUM(IF(period = 'year', clicks, 0)) AS INT64) as year, CAST(SUM(IF(period = 'cur', clicks, 0)) - SUM(IF(period = 'prev', clicks, 0)) AS INT64) as wow, CAST(SUM(IF(period = 'cur', clicks, 0)) - SUM(IF(period = 'year', clicks, 0)) AS INT64) as yoy FROM base GROUP BY 1 HAVING cur > 0 OR prev > 0 ORDER BY cur DESC LIMIT 300`;
  const results = runBQQuery(sql, BQ_PROJECT_ID);
  let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('êµ¬ê¸€ì„œì¹˜ì½˜ì†”') || SpreadsheetApp.getActiveSpreadsheet().insertSheet('êµ¬ê¸€ì„œì¹˜ì½˜ì†”');
  sheet.clear(); sheet.getRange(1,1,1,6).setValues([["í‚¤ì›Œë“œ(GSC)","ë³´ê³ ì£¼","ì „ì£¼","ì „ë…„ë™ê¸°","WoW","YoY"]]);
  if (results.length > 0) sheet.getRange(2,1,results.length,6).setValues(results);
}

function updateGA4WeeklyData(dates) {
  const sql = `WITH base AS (SELECT COALESCE((SELECT value.string_value FROM UNNEST(event_params) WHERE key = 'search_term'), 'N/A') as keyword, CASE WHEN _TABLE_SUFFIX BETWEEN '${dates.cur.bq}' AND '${dates.cur.bqEnd}' THEN 'cur' WHEN _TABLE_SUFFIX BETWEEN '${dates.prev.bq}' AND '${dates.prev.bqEnd}' THEN 'prev' WHEN _TABLE_SUFFIX BETWEEN '${dates.year.bq}' AND '${dates.year.bqEnd}' THEN 'year' END as period FROM \`${GA4_PROJECT_ID}.${GA4_DATASET_ID}.events_*\` WHERE _TABLE_SUFFIX BETWEEN '${dates.year.bq}' AND '${dates.cur.bqEnd}' AND event_name = 'view_search_results') SELECT keyword, COUNTIF(period = 'cur') as cur, COUNTIF(period = 'prev') as prev, COUNTIF(period = 'year') as year, (COUNTIF(period = 'cur') - COUNTIF(period = 'prev')) as wow, (COUNTIF(period = 'cur') - COUNTIF(period = 'year')) as yoy FROM base WHERE keyword != 'N/A' GROUP BY 1 HAVING cur > 0 OR prev > 0 ORDER BY cur DESC LIMIT 300`;
  const results = runBQQuery(sql, GA4_PROJECT_ID);
  let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('GA4ê²€ìƒ‰ì–´') || SpreadsheetApp.getActiveSpreadsheet().insertSheet('GA4ê²€ìƒ‰ì–´');
  sheet.clear(); sheet.getRange(1,1,1,6).setValues([["ë‚´ë¶€ê²€ìƒ‰ì–´(GA4)","ë³´ê³ ì£¼","ì „ì£¼","ì „ë…„ë™ê¸°","WoW","YoY"]]);
  if (results.length > 0) sheet.getRange(2,1,results.length,6).setValues(results);
}

function updateGA4InboundWeeklyData(dates) {
  const sql = `WITH session_base AS (SELECT user_pseudo_id, (SELECT value.int_value FROM UNNEST(event_params) WHERE key = 'ga_session_id') as session_id, traffic_source.source, traffic_source.medium, COALESCE((SELECT value.string_value FROM UNNEST(event_params) WHERE key = 'term'), CONCAT('(', traffic_source.medium, ')')) as keyword, CASE WHEN _TABLE_SUFFIX BETWEEN '${dates.cur.bq}' AND '${dates.cur.bqEnd}' THEN 'cur' WHEN _TABLE_SUFFIX BETWEEN '${dates.prev.bq}' AND '${dates.prev.bqEnd}' THEN 'prev' WHEN _TABLE_SUFFIX BETWEEN '${dates.year.bq}' AND '${dates.year.bqEnd}' THEN 'year' END as period, MAX(CASE WHEN EXISTS (SELECT 1 FROM UNNEST(event_params) WHERE key = 'page_location' AND (value.string_value LIKE '%estimate%' OR value.string_value LIKE '%G2000001274%')) THEN 1 ELSE 0 END) as is_target FROM \`${GA4_PROJECT_ID}.${GA4_DATASET_ID}.events_*\` WHERE _TABLE_SUFFIX BETWEEN '${dates.year.bq}' AND '${dates.cur.bqEnd}' GROUP BY 1, 2, 3, 4, 5, 6) SELECT source, medium, keyword, COUNT(DISTINCT IF(period = 'cur' AND is_target = 1, CONCAT(user_pseudo_id, CAST(session_id AS STRING)), NULL)) as cur, COUNT(DISTINCT IF(period = 'prev' AND is_target = 1, CONCAT(user_pseudo_id, CAST(session_id AS STRING)), NULL)) as prev, COUNT(DISTINCT IF(period = 'year' AND is_target = 1, CONCAT(user_pseudo_id, CAST(session_id AS STRING)), NULL)) as year FROM session_base WHERE period IS NOT NULL GROUP BY 1, 2, 3 HAVING cur > 0 OR prev > 0 ORDER BY cur DESC LIMIT 500`;
  const results = runBQQuery(sql, GA4_PROJECT_ID);
  let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('GA4ìœ ì…í‚¤ì›Œë“œ') || SpreadsheetApp.getActiveSpreadsheet().insertSheet('GA4ìœ ì…í‚¤ì›Œë“œ');
  sheet.clear(); sheet.getRange(1,1,1,8).setValues([["ì†ŒìŠ¤","ë§¤ì²´","í•µì‹¬ìœ ì…ê²½ë¡œ","ë³´ê³ ì£¼","ì „ì£¼","ì „ë…„ë™ê¸°","WoWì¦ê°","YoYì¦ê°"]]);
  if (results.length > 0) { const finalResults = results.map(r => [...r, (Number(r[3])-Number(r[4])), (Number(r[3])-Number(r[5]))]); sheet.getRange(2,1,finalResults.length, 8).setValues(finalResults); }
}
